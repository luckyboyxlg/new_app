<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<title>十七、B站播放量day01 - My Docs</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="generator" content="mkdocs-1.6.1, mkdocs-gitbook-1.0.7">

<link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta rel="next" href="" />
<link href="../css/style.min.css" rel="stylesheet"> 
</head>

<body>
<div class="book">
<div class="book-summary">
<div id="book-search-input" role="search">
<input type="text" placeholder="Type to search" />
</div> <!-- end of book-search-input -->

<nav role="navigation">
<ul class="summary">
<li>
<a href=".." target="_blank" class="custom-link">My Docs</a>
</li>
<li class="divider"></li>
<li class="chapter" data-path="">
<a href="..">Welcome to Lucky App逆向</a>
<li class="chapter" data-path="day01-%E5%BC%80%E7%8F%AD/">
<a href="../day01-%E5%BC%80%E7%8F%AD/">一、前期准备</a>
<li class="chapter" data-path="day02-adb/">
<a href="../day02-adb/">二、adb</a>
<li class="chapter" data-path="day03-%E6%8A%93%E5%8C%85%E5%92%8C%E5%8F%8D%E7%BC%96%E8%AF%91/">
<a href="../day03-%E6%8A%93%E5%8C%85%E5%92%8C%E5%8F%8D%E7%BC%96%E8%AF%91/">三、抓包和反编译</a>
<li class="chapter" data-path="day04-hook-%E5%B8%B8%E7%94%A8%E5%8A%A0%E5%AF%86-%E6%8A%93%E5%8C%85app/">
<a href="../day04-hook-%E5%B8%B8%E7%94%A8%E5%8A%A0%E5%AF%86-%E6%8A%93%E5%8C%85app/">四、hook-常用加密-抓包app</a>
<li class="chapter" data-path="day05-%E9%80%86x%E6%A1%88%E4%BE%8B/">
<a href="../day05-%E9%80%86x%E6%A1%88%E4%BE%8B/">五、抓包和逆向案例</a>
<li class="chapter" data-path="day06-java%E5%9F%BA%E7%A1%8001/">
<a href="../day06-java%E5%9F%BA%E7%A1%8001/">六、java基础-01</a>
<li class="chapter" data-path="day07-java%E5%9F%BA%E7%A1%8002/">
<a href="../day07-java%E5%9F%BA%E7%A1%8002/">七、java基础02</a>
<li class="chapter" data-path="day08-java%E5%9F%BA%E7%A1%8003/">
<a href="../day08-java%E5%9F%BA%E7%A1%8003/">八、java基础03</a>
<li class="chapter" data-path="day09-%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%9101/">
<a href="../day09-%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%9101/">Day09 安卓开发01</a>
<li class="chapter" data-path="day10-%E5%AE%89%E5%8D%93%E5%9F%BA%E7%A1%8002/">
<a href="../day10-%E5%AE%89%E5%8D%93%E5%9F%BA%E7%A1%8002/">十、安卓开发02</a>
<li class="chapter" data-path="day10%E5%AE%89%E5%8D%93%E5%9F%BA%E7%A1%80%E5%8A%A0%E5%AF%86%E6%8B%A6%E6%88%AA%E5%99%A8/">
<a href="../day10%E5%AE%89%E5%8D%93%E5%9F%BA%E7%A1%80%E5%8A%A0%E5%AF%86%E6%8B%A6%E6%88%AA%E5%99%A8/">十、安卓基础加密拦截器</a>
<li class="chapter" data-path="day11-C%E8%AF%AD%E8%A8%80%E5%AE%89%E8%A3%85/">
<a href="../day11-C%E8%AF%AD%E8%A8%80%E5%AE%89%E8%A3%85/">十一、C语言安装与入门</a>
<li class="chapter" data-path="day12-C%E8%AF%AD%E8%A8%80%E5%92%8CJNI%E5%BC%80%E5%8F%91/">
<a href="../day12-C%E8%AF%AD%E8%A8%80%E5%92%8CJNI%E5%BC%80%E5%8F%91/">十二、C语言和JNI开发</a>
<li class="chapter" data-path="day13-JNI%E5%BC%80%E5%8F%91/">
<a href="../day13-JNI%E5%BC%80%E5%8F%91/">十三、JNI开发</a>
<li class="chapter" data-path="day14-%E8%BD%A6%E6%99%BA%E8%B5%A2/">
<a href="../day14-%E8%BD%A6%E6%99%BA%E8%B5%A2/">十四、车智赢</a>
<li class="chapter" data-path="day15-%E8%AF%86%E8%B4%A7app/">
<a href="../day15-%E8%AF%86%E8%B4%A7app/">十五、识货app</a>
<li class="chapter" data-path="day16-%E5%BE%97%E7%89%A9app/">
<a href="../day16-%E5%BE%97%E7%89%A9app/">十六、得物app</a>
<li class="chapter active" data-path="day17-B%E7%AB%99%E6%92%AD%E6%94%BE%E9%87%8Fday01/">
<a href="./">十七、B站播放量day01</a>
<li class="chapter" data-path="day18-B%E7%AB%9902/">
<a href="../day18-B%E7%AB%9902/">十八、B站02</a>
<li class="chapter" data-path="day19-B%E7%AB%9903/">
<a href="../day19-B%E7%AB%9903/">十九、B站02</a>
<li class="chapter" data-path="day20-%E5%94%AF%E5%93%81%E4%BC%9A01/">
<a href="../day20-%E5%94%AF%E5%93%81%E4%BC%9A01/">二十、唯品会01</a>
<li class="chapter" data-path="day21-%E5%94%AF%E5%93%81%E4%BC%9A02/">
<a href="../day21-%E5%94%AF%E5%93%81%E4%BC%9A02/">二十一、唯品会02</a>
<li class="chapter" data-path="day22-DYM/">
<a href="../day22-DYM/">二十二、DYM</a>
<li class="chapter" data-path="day23-%E9%85%92%E4%BB%99%E7%BD%91/">
<a href="../day23-%E9%85%92%E4%BB%99%E7%BD%91/">二十三、酒仙网</a>
<li class="chapter" data-path="day24-%E5%8F%B8%E5%B0%8F%E5%AE%9D/">
<a href="../day24-%E5%8F%B8%E5%B0%8F%E5%AE%9D/">二十四、司小宝</a>
<li class="chapter" data-path="day25-unidbg-%E4%B8%8A/">
<a href="../day25-unidbg-%E4%B8%8A/">二十五、unidbg-上</a>
<li class="chapter" data-path="day26-unidbg-%E4%B8%AD%E7%AF%87/">
<a href="../day26-unidbg-%E4%B8%AD%E7%AF%87/">二十六、unidbg-中</a>
<li class="chapter" data-path="day27-unidbg-%E4%B8%8B/">
<a href="../day27-unidbg-%E4%B8%8B/">二十七、unidbg-下</a>
<li class="chapter" data-path="day28-xhs-%E4%B8%8A/">
<a href="../day28-xhs-%E4%B8%8A/">二十八、xhs-上</a>
<li class="chapter" data-path="day29-xhs-%E4%B8%8B/">
<a href="../day29-xhs-%E4%B8%8B/">二十九、xhs-下</a>
<li class="chapter" data-path="day30-%E6%97%A0%E9%9A%9C%E7%A2%8D/">
<a href="../day30-%E6%97%A0%E9%9A%9C%E7%A2%8D/">三十、无障碍开发</a>
<li class="chapter" data-path="day31-%E6%97%A0%E9%9A%9C%E7%A2%8D/">
<a href="../day31-%E6%97%A0%E9%9A%9C%E7%A2%8D/">三十一、无障碍image-20240703160302051</a>
<li class="chapter" data-path="day32-%E6%97%A0%E9%9A%9C%E7%A2%8D%E9%83%A8%E7%BD%B2/">
<a href="../day32-%E6%97%A0%E9%9A%9C%E7%A2%8D%E9%83%A8%E7%BD%B2/">三十二、无障碍项目部署</a>
<li class="divider"></li>



<li><a href="http://www.mkdocs.org">
Published with MkDocs
</a></li>

<li><a href="https://github.com/GitbookIO/theme-default">
Theme by GitBook
</a></li>
</ul>

</nav>

</div> <!-- end of book-summary -->

<div class="book-body">
<div class="body-inner">
<div class="book-header" role="navigation">

<!-- Title -->
<h1>
<i class="fa fa-circle-o-notch fa-spin"></i>
<a href="." ></a>
</h1>

</div> <!-- end of book-header -->

<div class="page-wrapper" tabindex="-1" role="main">
<div class="page-inner">
<div id="book-search-results">
<div class="search-noresults">

<section class="normal markdown-section">



<h1 id="bday01">十七、B站播放量day01</h1>
<h1 id="1">1 目标和版本</h1>
<pre><code class="language-python"># 目标：B站视频刷播放量
# 版本：v6.24.0
</code></pre>
<h1 id="2">2 抓包</h1>
<pre><code class="language-python"># 1 B站没有反代理---》直接手机配置代理抓包即可
# 2 打开B站app，随便点击一个视频，抓包查看
    -定位到某个可以提高播放量的接口
    -多次重复发请求尝试，查看播放量是否增加
# 3 抓包分析地址
    -请求地址：https://api.bilibili.com/x/report/click/android2
    -请求方式：POST
    -请求体：（二进制形式）加密的
        一堆二进制
    -请求头：（都可以去掉--》但是咱么要破）
        buvid   
        device-id
        fp_local
        fp_remote
        session_id

</code></pre>
<p><img alt="image-20230803162146692" src="../imgs/day17-B%E7%AB%99%E6%92%AD%E6%94%BE%E9%87%8Fday01.assets/image-20230803162146692.png" /></p>
<h1 id="3">3 反编译</h1>
<h2 id="31-jadx">3.1 jadx增加内存</h2>
<pre><code class="language-python"># jadx-gui 反编译app的时候内存不足
1.使用记事本或者notpad++打开jadx-gui.bat
2.找到 set DEFAULT_JVM_OPTS=&quot;-Xms128M&quot; &quot;-Xmx4g&quot;
3.将其修改为 set DEFAULT_JVM_OPTS=&quot;-Xms128M&quot; &quot;-Xmx16g&quot; 后保存就ok了 (你要4g 提升到16g把-Xmx4g改成-Xmx16g)
</code></pre>
<p><img alt="image-20230803163140464" src="../imgs/day17-B%E7%AB%99%E6%92%AD%E6%94%BE%E9%87%8Fday01.assets/image-20230803163140464.png" /></p>
<p><img alt="image-20230803163358343" src="../imgs/day17-B%E7%AB%99%E6%92%AD%E6%94%BE%E9%87%8Fday01.assets/image-20230803163358343.png" /></p>
<h1 id="4">4 请求体加密算法破解</h1>
<pre><code class="language-python"># 1 反编译后---》搜索请求地址： click/android2
# 2 一个位置，双击进入
# 3 查找用例：reportClick，就只有一个位置
# 4 代码如下--》变量都是&quot;魔鬼变量&quot;  a  b  c 单个字母变量--》代码混淆了--》难读
# jadx可以简单反混淆--》读起来稍微好读一些，但是，当我们去hook的时候，还是用hook混淆的方法名，a，b

-咱们之前写的代码
String responseString = retrofit.create(HttpReq.class).Login(username, password, sign).execute().body().string();

-反编译回来的
l&lt;String&gt; execute = retrofit.create(a.class)).reportClick(create).execute();

# 5 核心是查看 create 传了什么东西---》因为它就是请求体
c0 create = c0.create('编码方式', d.this.H7(this.b.a(), this.b.b(), this.b.h(), i, j2, this.b.n(), this.b.m(), this.b.k(), this.b.c(), this.b.e(), this.b.l(), this.b.f()));

# 6 真正的内容：d.this.H7 执行完返回的结果
    H7方法，有很多很多参数

# 7 d.this.H7 源码分析
</code></pre>
<h2 id="40">4.0 搜索定位分析</h2>
<p><img alt="image-20230803163647956" src="../imgs/day17-B%E7%AB%99%E6%92%AD%E6%94%BE%E9%87%8Fday01.assets/image-20230803163647956.png" /></p>
<pre><code class="language-java">public final void a() {
    long j2;
    long i = c2.f.f.c.j.a.i() / 1000;
    c2.f.b0.c.b.b.a.a E = c2.f.b0.c.b.b.a.a.E();
    long A = E.A();
    if (A == -1) {
        c2.f.b0.c.b.b.a.a E2 = c2.f.b0.c.b.b.a.a.E();
        E2.V(i);
        j2 = i;
    } else {
        j2 = A;
    }
    c0 create = c0.create(w.d(com.hpplay.sdk.source.protocol.h.E), d.this.H7(this.b.a(), this.b.b(), this.b.h(), i, j2, this.b.n(), this.b.m(), this.b.k(), this.b.c(), this.b.e(), this.b.l(), this.b.f()));
    // retrofit.create(HttpReq.class).getFilm(&quot;&quot;).execute()
    // create 就是请求体内容，create是通过c0.create得到的
    l&lt;String&gt; execute = ((tv.danmaku.biliplayerimpl.report.heartbeat.a) com.bilibili.okretro.c.a(tv.danmaku.biliplayerimpl.report.heartbeat.a.class)).reportClick(create).execute();
    int b = execute.b();
    String h = execute.h();
}

/*
c0 create = c0.create(w.d(com.hpplay.sdk.source.protocol.h.E), d.this.H7(this.b.a(), this.b.b(), this.b.h(), i, j2, this.b.n(), this.b.m(), this.b.k(), this.b.c(), this.b.e(), this.b.l(), this.b.f()));

com.hpplay.sdk.source.protocol.h.E是一个常量：application/octet-stream
d.this.H7：传入了参数，我们查看H7代码  
*/

</code></pre>
<h3 id="401-dthish7">4.0.1 d.this.H7</h3>
<pre><code class="language-java">public final byte[] H7(long j2, long j4, int i, long j5, long j6, int i2, int i3, long j7, String str, int i4, String str2, String str3) throws Exception {
    long j8;
    int i5;
    Application f2 = BiliContext.f();
    com.bilibili.lib.accounts.b client = com.bilibili.lib.accounts.b.f(f2);
    AccountInfo h = BiliAccountInfo.f.a().h();
    if (h != null) {
        j8 = h.getMid();
        i5 = h.getLevel();
    } else {
        j8 = 0;
        i5 = 0;
    }
    // 1 把一堆 key  和 value 放到了 TreeMap中
    TreeMap treeMap = new TreeMap();
    treeMap.put(&quot;aid&quot;, String.valueOf(j2));
    treeMap.put(&quot;cid&quot;, String.valueOf(j4));
    treeMap.put(&quot;part&quot;, String.valueOf(i));
    treeMap.put(EditCustomizeSticker.TAG_MID, String.valueOf(j8));
    treeMap.put(&quot;lv&quot;, String.valueOf(i5));
    treeMap.put(&quot;ftime&quot;, String.valueOf(j6));
    treeMap.put(&quot;stime&quot;, String.valueOf(j5));
    treeMap.put(&quot;did&quot;, com.bilibili.lib.biliid.utils.f.a.c(f2));
    treeMap.put(&quot;type&quot;, String.valueOf(i2));
    treeMap.put(&quot;sub_type&quot;, String.valueOf(i3));
    treeMap.put(&quot;sid&quot;, String.valueOf(j7));
    treeMap.put(&quot;epid&quot;, str);
    treeMap.put(&quot;auto_play&quot;, String.valueOf(i4));
    x.h(client, &quot;client&quot;);
    if (client.r()) {
        treeMap.put(&quot;access_key&quot;, client.g());
    }
    treeMap.put(&quot;build&quot;, String.valueOf(com.bilibili.api.a.f()));
    treeMap.put(&quot;mobi_app&quot;, com.bilibili.api.a.l());
    treeMap.put(&quot;spmid&quot;, str2);
    treeMap.put(&quot;from_spmid&quot;, str3);
    // 2 构建sb对象，把treeMap的内容，拼成字符串了
    // aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd&amp;
    StringBuilder sb = new StringBuilder();
    for (Map.Entry entry : treeMap.entrySet()) {
        String str4 = (String) entry.getValue();
        sb.append((String) entry.getKey());
        sb.append('=');
        if (str4 == null) {
            str4 = &quot;&quot;;
        }
        sb.append(str4);
        sb.append('&amp;');
    }
    // 3 sb=aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd
    sb.deleteCharAt(sb.length() - 1);
    // 4 转成字符串了 aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd
    String sb2 = sb.toString();
    // 5 调用： t3.a.i.a.a.a.b.e.b对 aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd进行加密，得到字符串
    String b2 = t3.a.i.a.a.a.b.e.b(sb2);
    // 6 sb=aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd&amp;sign=加密串
    sb.append(&quot;&amp;sign=&quot;);
    sb.append(b2);
    String sb3 = sb.toString();
    // 7 对整个字符串：aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd&amp;sign=加密串 调用了a加密得到结果
    return t3.a.i.a.a.a.b.e.a(sb3);
}

/*
1 把一堆 key  和 value 放到了 TreeMap中
2 构建sb对象，把treeMap的内容，拼成字符串了
     aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd&amp;
3 把字符串最后 &amp; 删除
sb=aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd
4 调用： t3.a.i.a.a.a.b.e.b对 aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd进行加密，得到字符串
5 把加密后的字符串拼接到 aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd 后面
sb=aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd&amp;sign=加密串
6 调用t3.a.i.a.a.a.b.e.a(sb3)对 上述字符串加密
7 得到的就是 请求体的内
*/
</code></pre>
<h3 id="402-hook-h7">4.0.2 hook--&gt;h7查看</h3>
<pre><code class="language-python">import subprocess
subprocess.run('adb forward tcp:27042 tcp:27042')
subprocess.run('adb forward tcp:27043 tcp:27043')
</code></pre>
<pre><code class="language-python">import frida
import sys

rdev = frida.get_remote_device()
session = rdev.attach(&quot;哔哩哔哩&quot;)

scr = &quot;&quot;&quot;
Java.perform(function () {

    var d = Java.use(&quot;tv.danmaku.biliplayerimpl.report.heartbeat.d&quot;);
    var ByteString = Java.use(&quot;com.android.okhttp.okio.ByteString&quot;);
    d.H7.implementation = function(j2,  j4,  i2,  j5,  j6,  i3,  i4,  j7,  str,  i5,  str2,  str3){
        console.log(&quot;请求来了&quot;);
        var res = this.H7(j2,  j4,  i2,  j5,  j6,  i3,  i4,  j7,  str,  i5,  str2,  str3);

        console.log(&quot;字节数组&quot;, res);
        console.log(&quot;字节数组&quot;, JSON.stringify(res));

        //console.log(ByteString.of(res).hex()); // 在hook时，直接把抓到的字符数组转成16进制
        //console.log(ByteString.of(res).utf8());  //将字节转换成字符串

        return res;
    };

});
&quot;&quot;&quot;

script = session.create_script(scr)
def on_message(message, data):
    print(message, data)


script.on(&quot;message&quot;, on_message)

script.load()
sys.stdin.read()

</code></pre>
<h3 id="403-16">4.0.3 把抓包得到的二进制字节数组--》转成16进制字符串</h3>
<pre><code class="language-python"># 把java的有符号的字节，转成python无符号的字节---》转成16进制

v=[-84,80,71,-56,45,62,-111,-96,41,107,1,-92,32,103,-68,5,62,10,-30,-1,88,-113,115,-110,-90,60,-44,8,3,50,106,112,126,-35,58,-73,5,22,2,61,5,105,-104,-16,88,-94,27,-109,72,-112,16,-103,-111,-73,98,-49,54,19,121,9,-55,-60,-124,-3,-18,126,91,-10,-102,109,71,16,-114,101,-29,-125,125,108,-22,-89,46,43,-56,106,96,-77,-89,-12,11,65,-8,-24,71,119,53,72,-54,-95,-20,-85,-110,-69,-126,-101,60,-105,33,-126,-66,-70,-86,66,-46,3,-38,73,-81,-104,-7,82,92,31,99,-89,-116,-119,61,6,123,-113,-58,1,98,90,-23,-83,25,-3,107,116,-76,123,43,64,90,-62,91,68,111,78,0,95,-89,-2,-1,44,-15,-112,-123,-89,-124,-18,-82,-112,-46,12,-80,-111,-110,94,-82,80,-91,54,-73,55,8,22,-2,-125,-39,-90,5,67,-108,-119,-16,-97,-13,-5,-127,12,-81,79,18,52,107,48,-10,58,-9,28,-12,102,86,-110,46,83,63,61,17,-55,44,67,-37,-53,-85,-7,-36,93,127,-16,-94,87,34,-3,-75,-99,40,-30,-39,-1,0,123,14,-108,10,71,72,96,6,118,89,-89,-95,75,111,2,47,97,20,26,-68,-43,77,-97,112,-32,54,-81,0,51,-69,-92,-92,72,-109,36,-61,-91,94,31,29,48,-100,118,-83,-15,19,22,89,43,-74,-60,92,99,116,-66,-15,-121,-66,-27,18,-13,-126,109,-14,69,-113,102,-69,-95,-76,-56,10,-112,-16,28,-76,-118,109,-66,35,-52,10,80,-61,-121,-6,-75,-4,-109,-102,110,18,-94,96,84,-117,-81,44,-7,-124,-26,66,-63]
l=[]
for i in v:
    if i&lt;0:
        i=i+256
    l.append(i)
print(l) # 转成16进制
res=[hex(item)[2:] for item in l]
print(res)
print(''.join(res)) # 转成字符串


'''
对比输出发现跟抓包到的16进制内容一致

'''
</code></pre>
<p><img alt="image-20230803170659828" src="../imgs/day17-B%E7%AB%99%E6%92%AD%E6%94%BE%E9%87%8Fday01.assets/image-20230803170659828.png" /></p>
<h2 id="41-sign">4.1 sign签名</h2>
<pre><code class="language-python"># 1 上面分析的：
 调用：t3.a.i.a.a.a.b.e.b对 aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd进行加密，得到签名字符串
# 2 代码如下--》破解加密如何加的--》sign是如何加密的
# sb2    aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd
String b2 = t3.a.i.a.a.a.b.e.b(sb2); # 加密后拼接到了字符串后面
sb.append(&quot;&amp;sign=&quot;);
sb.append(b2);
# 最终变成 aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd&amp;sign=签名

# 3 查看 t3.a.i.a.a.a.b.e.b# 1 上面分析的：
 调用：t3.a.i.a.a.a.b.e.b对 aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd进行加密，得到签名字符串
# 2 代码如下--》破解加密如何加的--》sign是如何加密的
# sb2    aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd
String b2 = t3.a.i.a.a.a.b.e.b(sb2); # 加密后拼接到了字符串后面
sb.append(&quot;&amp;sign=&quot;);
sb.append(b2);
# 最终变成 aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd&amp;sign=签名

# 3 查看 t3.a.i.a.a.a.b.e.b
</code></pre>
<h3 id="411-dthish7">4.1.1 分析d.this.H7源码</h3>
<pre><code class="language-java">public final byte[] H7(long j2, long j4, int i, long j5, long j6, int i2, int i3, long j7, String str, int i4, String str2, String str3) throws Exception {
    // 1 把一堆key-value放到TreeMap中
    TreeMap treeMap = new TreeMap();
    treeMap.put(&quot;aid&quot;, String.valueOf(j2));
    treeMap.put(&quot;cid&quot;, String.valueOf(j4));
    treeMap.put(&quot;part&quot;, String.valueOf(i));
    treeMap.put(EditCustomizeSticker.TAG_MID, String.valueOf(j8));
    treeMap.put(&quot;lv&quot;, String.valueOf(i5));
    treeMap.put(&quot;ftime&quot;, String.valueOf(j6));
    treeMap.put(&quot;stime&quot;, String.valueOf(j5));
    treeMap.put(&quot;did&quot;, com.bilibili.lib.biliid.utils.f.a.c(f2));
    treeMap.put(&quot;type&quot;, String.valueOf(i2));
    treeMap.put(&quot;sub_type&quot;, String.valueOf(i3));
    treeMap.put(&quot;sid&quot;, String.valueOf(j7));
    treeMap.put(&quot;epid&quot;, str);
    treeMap.put(&quot;auto_play&quot;, String.valueOf(i4));
    x.h(client, &quot;client&quot;);
    if (client.r()) {
        treeMap.put(&quot;access_key&quot;, client.g());
    }
    treeMap.put(&quot;build&quot;, String.valueOf(com.bilibili.api.a.f()));
    treeMap.put(&quot;mobi_app&quot;, com.bilibili.api.a.l());
    treeMap.put(&quot;spmid&quot;, str2);
    treeMap.put(&quot;from_spmid&quot;, str3);
    StringBuilder sb = new StringBuilder();
    for (Map.Entry entry : treeMap.entrySet()) {
        String str4 = (String) entry.getValue();
        sb.append((String) entry.getKey());
        sb.append('=');
        if (str4 == null) {
            str4 = &quot;&quot;;
        }
        sb.append(str4);
        sb.append('&amp;');
    }
    //  2 把treeMap放入的内容，拼成字符串
    //aid=asdfsd&amp;cid=121342&amp;part=3dseffs&amp;
    sb.deleteCharAt(sb.length() - 1);
    // 3 把最后的&amp;符号删除
    String sb2 = sb.toString();
    // 4 调用t3.a.i.a.a.a.b.e.b把上面字符串传入，返回b2
    String b2 = t3.a.i.a.a.a.b.e.b(sb2);
    // 5 继续拼接sign=
    sb.append(&quot;&amp;sign=&quot;);
    sb.append(b2);
    String sb3 = sb.toString();
    // 6 最终调用了t3.a.i.a.a.a.b.e.a 把字符串传入了
    return t3.a.i.a.a.a.b.e.a(sb3);
}

/*
// 1 把一堆key-value放到TreeMap中
//  2 把treeMap放入的内容，拼成字符串
//aid=asdfsd&amp;cid=121342&amp;part=3dseffs&amp;
// 3 把最后的&amp;符号删除
// 4 调用t3.a.i.a.a.a.b.e.b把上面字符串传入，返回b2
String b2 = t3.a.i.a.a.a.b.e.b(sb2);
// 5 继续拼接sign=
// 6 最终调用了t3.a.i.a.a.a.b.e.a 把字符串传入了
t3.a.i.a.a.a.b.e.a(sb3);
我们要研究：t3.a.i.a.a.a.b.e.b和t3.a.i.a.a.a.b.e.a

*/
</code></pre>
<h3 id="412-t3aiaaabeb">4.1.2 分析t3.a.i.a.a.a.b.e.b</h3>
<h4 id="4121-t3aiaaabeb">4.1.2.1 t3.a.i.a.a.a.b.e.b</h4>
<pre><code class="language-java">public final String b(String params) {
    Charset charset = com.bilibili.commons.c.b;
    //1  把传入的params字符串，得到bytes格式，params=aid=asdfsd&amp;cid=121342&amp;part=3dseffs
    byte[] bytes = params.getBytes(charset);
    //2 d 是类中一个常量
    String str = d;
    //3 com.bilibili.commons.c.b也是个常量
    Charset charset2 = com.bilibili.commons.c.b;
    if (str != null) {
        //4 把charset2转成字节数组
        byte[] bytes2 = str.getBytes(charset2);
        //5 调用com.bilibili.commons.m.a.g完成加密
        String g = com.bilibili.commons.m.a.g(bytes, bytes2);
        Locale locale = Locale.US;
        if (g != null) {
            String lowerCase = g.toLowerCase(locale);
            // 6 转成小写返回
            return lowerCase;
        }
        throw new TypeCastException(&quot;null cannot be cast to non-null type java.lang.String&quot;);
    }
    throw new TypeCastException(&quot;null cannot be cast to non-null type java.lang.String&quot;);
}


// 继续分析com.bilibili.commons.m.a.g(bytes, bytes2)
// 典型的SHA256加密:对传入的两个参数加密，一个是加密体，一个是盐，盐一般不变

</code></pre>
<h4 id="4122-combilibilicommonsmagbytes-bytes2">4.1.2.2 com.bilibili.commons.m.a.g(bytes, bytes2)</h4>
<pre><code class="language-java">// 继续分析com.bilibili.commons.m.a.g(bytes, bytes2)
// 典型的SHA256加密:对传入的两个参数加密，一个是加密体，一个是盐，盐一般不变
public static String g(byte[] bArr, byte[] bArr2) {
    try {
        MessageDigest messageDigest = MessageDigest.getInstance(AaidIdConstant.SIGNATURE_SHA256);
        messageDigest.reset();
        messageDigest.update(bArr);
        if (bArr2 != null) {
            messageDigest.update(bArr2);
        }
        // 又调用了g.H
        return g.H(messageDigest.digest());
    } catch (NoSuchAlgorithmException e) {
        throw new AssertionError(e);
    }
}
// 继续分析g.H---》就是把传入的字符数组转成16进制字符串
</code></pre>
<h4 id="4123-gh">4.1.2.3 g.H</h4>
<pre><code class="language-java">// 继续分析g.H---》就是把传入的字符数组转成16进制字符串
public static String H(byte[] bArr) {
    StringBuilder sb = new StringBuilder();
    for (byte b2 : bArr) {
        int i = b2 &amp; 255;
        if (i &lt; 16) {
            sb.append('0');
        }
        sb.append(Integer.toHexString(i));
    }
    return sb.toString();
}
</code></pre>
<h4 id="4124-hook-gsha256">4.1.2.4 hook--&gt;g看看sha256的盐是什么</h4>
<pre><code class="language-python">import frida
import sys

rdev = frida.get_remote_device()
# Application(identifier=&quot;tv.danmaku.bili&quot;, name=&quot;哔哩哔哩&quot;, pid=20650, parameters={})
session = rdev.attach(&quot;哔哩哔哩&quot;)

scr = &quot;&quot;&quot;
Java.perform(function () {
    var a = Java.use(&quot;com.bilibili.commons.m.a&quot;);
    var ByteString = Java.use(&quot;com.android.okhttp.okio.ByteString&quot;);
    a.g.implementation = function(bytes, bytes2){
        console.log(&quot;请求来了&quot;);
        console.log(&quot;bytes=&quot;,ByteString.of(bytes).utf8());
        console.log(&quot;bytes2=&quot;,ByteString.of(bytes2).utf8());

        var res = this.g(bytes, bytes2);
        console.log(&quot;sign=&quot;,res);

        return res;
    };

});
&quot;&quot;&quot;

script = session.create_script(scr)


def on_message(message, data):
    print(message, data)


script.on(&quot;message&quot;, on_message)

script.load()
sys.stdin.read()


# 多试几次发现盐是：9cafa6466a028bfb

### 总结：sign逻辑
    1 一串字符串aid=319287973&amp;auto_play=0&amp;build=6240300&amp;cid=1289959578&amp;did=IBksFHYQJ0QiF3FAckQmFVUFbBRxHS93Ow&amp;epid=&amp;from_spmid=main.ugc-video-detail.0.0&amp;ftime=1692278308&amp;lv=0&amp;mid=0&amp;mobi_app=android&amp;part=1&amp;sid=0&amp;spmid=main.ugc-video-detail.0.0&amp;stime=1697634744&amp;sub_type=0&amp;type=3
    2 通过盐：9cafa6466a028bfb  + sha256 加密 得到加密串
    3 转成16进制
</code></pre>
<h4 id="4125-pythonsha256">4.1.2.5 python实现sha256加密</h4>
<pre><code class="language-python">import hashlib

data = &quot;aid=201583388&amp;auto_play=0&amp;build=6240300&amp;cid=219823580&amp;did=IBksFHYQJ0QiF3FAckQmFVUFbBRxHS93Ow&amp;epid=&amp;from_spmid=main.ugc-video-detail.0.0&amp;ftime=1690993444&amp;lv=0&amp;mid=0&amp;mobi_app=android&amp;part=1&amp;sid=0&amp;spmid=main.ugc-video-detail.0.0&amp;stime=1691055961&amp;sub_type=0&amp;type=3&quot;

salt = &quot;9cafa6466a028bfb&quot;
obj = hashlib.sha256()
obj.update(data.encode('utf-8'))
obj.update(salt.encode('utf-8'))

res = obj.hexdigest()
print(res)

'''
bytes= aid=201583388&amp;auto_play=0&amp;build=6240300&amp;cid=219823580&amp;did=IBksFHYQJ0QiF3FAckQmFVUFbBRxHS93Ow&amp;epid=&amp;from_spmid=main.ugc-video-detail.0.0&amp;ftime=1690993444&amp;lv=0&amp;mid=0&amp;mobi_app=android&amp;part=1&amp;sid=0&amp;spmid=main.ugc-video-detail.0.0&amp;stime=1691055961&amp;sub_type=0&amp;type=3
bytes2= 9cafa6466a028bfb
sign= 2c3744b21ae185adf9e9d90b4b2f89e8826b4837a6fcc78aae2438e9cb55e280

# 自己使用python加密得到结果：是一样的
2c3744b21ae185adf9e9d90b4b2f89e8826b4837a6fcc78aae2438e9cb55e280
'''
</code></pre>
<h2 id="42">4.2 请求体内容加密</h2>
<h3 id="421-t3aiaaabea-">4.2.1 分析t3.a.i.a.a.a.b.e.a--》返回字节数组</h3>
<pre><code class="language-java">// aes加密
public final byte[] a(String body) {
    try {
        String str = b;
        Charset charset = com.bilibili.commons.c.b;
        if (str != null) {
            byte[] bytes = str.getBytes(charset);
            // 那aes加密的秘钥：
            SecretKeySpec secretKeySpec = new SecretKeySpec(bytes, &quot;AES&quot;);
            String str2 = f22911c;
            Charset charset2 = com.bilibili.commons.c.b;
            if (str2 != null) {
                byte[] bytes2 = str2.getBytes(charset2);
                // 拿aes加密的iv
                IvParameterSpec ivParameterSpec = new IvParameterSpec(bytes2);
                Charset charset3 = com.bilibili.commons.c.b;
                byte[] bytes3 = body.getBytes(charset3);
                byte[] i = com.bilibili.droid.g0.a.i(secretKeySpec, ivParameterSpec, bytes3);
                return i;
            }
            throw new TypeCastException(&quot;null cannot be cast to non-null type java.lang.String&quot;);
        }
        throw new TypeCastException(&quot;null cannot be cast to non-null type java.lang.String&quot;);
    } catch (Exception e2) {
        BLog.e(a, e2);
        Charset charset4 = com.bilibili.commons.c.b;
        x.h(charset4, &quot;Charsets.UTF_8&quot;);
        byte[] bytes4 = body.getBytes(charset4);
        x.h(bytes4, &quot;(this as java.lang.String).getBytes(charset)&quot;);
        return bytes4;
    }
}

// 可以通过hook拿到iv和key--》需要hook----SecretKeySpec和IvParameterSpec构造函数
// 其实iv和可以都在上面 key=fd6b639dbcff0c2a1b03b389ec763c4b   iv=77b07a672d57d64c
static {
    String str = (String) a.C1483a.a(ConfigManager.Companion.b(), &quot;videodetail.report_click_secret_key&quot;, null, 2, null);
    if (str == null) {
        str = &quot;fd6b639dbcff0c2a1b03b389ec763c4b&quot;;
    }
    b = str;
    String str2 = (String) a.C1483a.a(ConfigManager.Companion.b(), &quot;videodetail.report_click_iv&quot;, null, 2, null);
    if (str2 == null) {
        str2 = &quot;77b07a672d57d64c&quot;;
    }
    f22911c = str2;
    String str3 = (String) a.C1483a.a(ConfigManager.Companion.b(), &quot;videodetail.report_click_salt&quot;, null, 2, null);
    if (str3 == null) {
        str3 = &quot;9cafa6466a028bfb&quot;;
    }
    d = str3;
}


</code></pre>
<h3 id="422-hook-aesiv">4.2.2 hook--&gt;得到aes秘钥和iv</h3>
<pre><code class="language-python">import frida
import sys

rdev = frida.get_remote_device()
session = rdev.attach(&quot;哔哩哔哩&quot;)

scr = &quot;&quot;&quot;
Java.perform(function () {
    var ByteString = Java.use(&quot;com.android.okhttp.okio.ByteString&quot;);

    var SecretKeySpec = Java.use(&quot;javax.crypto.spec.SecretKeySpec&quot;);
    SecretKeySpec.$init.overload('[B', 'java.lang.String').implementation = function(key,name){
        console.log(&quot;请求来了&quot;);
        console.log(&quot;key=&quot;,ByteString.of(key).utf8());
        console.log(&quot;name=&quot;,name);

        var res = this.$init(key,name);
        return res;
    };

    var IvParameterSpec = Java.use(&quot;javax.crypto.spec.IvParameterSpec&quot;);
    IvParameterSpec.$init.overload('[B').implementation = function(iv){
        console.log(&quot;iv=&quot;,ByteString.of(iv).utf8());
        var res = this.$init(iv);
        return res;
    };

});
&quot;&quot;&quot;

script = session.create_script(scr)


def on_message(message, data):
    print(message, data)


script.on(&quot;message&quot;, on_message)

script.load()
sys.stdin.read()

'''
最终：aes的秘钥是
key= fd6b639dbcff0c2a1b03b389ec763c4b
name= AES
aes的iv是
iv= 77b07a672d57d64c
'''
</code></pre>
<h3 id="423-pythonaes">4.2.3 python实现aes加密</h3>
<pre><code class="language-python">from Crypto.Cipher import AES
from Crypto.Util.Padding import pad

KEY = &quot;fd6b639dbcff0c2a1b03b389ec763c4b&quot;
IV = &quot;77b07a672d57d64c&quot;

def aes_encrypt(data_string):
    aes = AES.new(
        key=KEY.encode('utf-8'),
        mode=AES.MODE_CBC,
        iv=IV.encode('utf-8')
    )
    raw = pad(data_string.encode('utf-8'), 16)
    return aes.encrypt(raw)


data = &quot;aid=201583388&amp;auto_play=0&amp;build=6240300&amp;cid=219823580&amp;did=IBksFHYQJ0QiF3FAckQmFVUFbBRxHS93Ow&amp;epid=&amp;from_spmid=main.ugc-video-detail.0.0&amp;ftime=1690993444&amp;lv=0&amp;mid=0&amp;mobi_app=android&amp;part=1&amp;sid=0&amp;spmid=main.ugc-video-detail.0.0&amp;stime=1691055961&amp;sub_type=0&amp;type=3&amp;sign=2c3744b21ae185adf9e9d90b4b2f89e8826b4837a6fcc78aae2438e9cb55e280&quot;

# 字节类型
bytes_data = aes_encrypt(data)

result = [item for item in bytes_data]
print(result)
</code></pre>
<h2 id="43">4.3   总结流程</h2>
<pre><code class="language-python"># 1 根据请求地址：x/report/click/android2  ---》反编译查找
# 2 retrofit发送请求---》用例
    ResponseBody responseBody = retrofit.create(接口类a.class).reportClick(参数).execute().body()
# 3 破解参数，create
# 4 参数是通过：d.this.H7 传了一堆参数进去，得到的结果

# 5 H7的逻辑是：
'''
1 把一堆 key  和 value 放到了 TreeMap中
2 构建sb对象，把treeMap的内容，拼成字符串了
     aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd&amp;
3 把字符串最后 &amp; 删除
sb=aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd
4 调用： t3.a.i.a.a.a.b.e.b对 aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd进行加密，得到字符串
5 把加密后的字符串拼接到 aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd 后面
sb=aid=asdfasdf&amp;cid=asadfasd&amp;part=sadfasd&amp;sign=加密串
6 调用t3.a.i.a.a.a.b.e.a(sb3)对 上述字符串加密
7 得到的就是 请求体的内容
'''

# 6 破解sign加密
    -sha256+盐 

# 7 得到最终的字符串，又加密了---》aes加密：秘钥，iv，明文
</code></pre>
<h1 id="5-aidciddid">5 请求体中aid，cid，did破解</h1>
<pre><code class="language-python"># 把请求体字符串转成字典
&quot;aid=201583388&amp;auto_play=0&amp;build=6240300&amp;cid=219823580&amp;did=IBksFHYQJ0QiF3FAckQmFVUFbBRxHS93Ow&amp;epid=&amp;from_spmid=main.ugc-video-detail.0.0&amp;ftime=1690993444&amp;lv=0&amp;mid=0&amp;mobi_app=android&amp;part=1&amp;sid=0&amp;spmid=main.ugc-video-detail.0.0&amp;stime=1691055961&amp;sub_type=0&amp;type=3&quot;

# 字典
{
    &quot;aid&quot;:&quot;201583388&quot;,
    &quot;cid&quot;:&quot;219823580&quot;,
    ---视频和分级id---请求返回的--通过网页版返回

    ---需要破-----
    &quot;did&quot;:&quot;IBksFHYQJ0QiF3FAckQmFVUFbBRxHS93Ow&quot;,
    ---视频打开时间和播放时间----
    &quot;ftime&quot;:&quot;1690993444&quot;,
    &quot;stime&quot;:&quot;1691055961&quot;,
    -----下面都固定-----
    &quot;auto_play&quot;:&quot;0&quot;,  # 固定
    &quot;build&quot;:&quot;6240300&quot;, # 版本
    &quot;epid&quot;:&quot;&quot;,    # 空 
    &quot;from_spmid&quot;:&quot;main.ugc-video-detail.0.0&quot;,# 固定
    &quot;lv&quot;:&quot;0&quot;, 
    &quot;mid&quot;:&quot;0&quot;,
    &quot;mobi_app&quot;:&quot;android&quot;,
    &quot;part&quot;:&quot;1&quot;,
    &quot;sid&quot;:&quot;0&quot;,
    &quot;spmid&quot;:&quot;main.ugc-video-detail.0.0&quot;,
    &quot;sub_type&quot;:&quot;0&quot;,
    &quot;type&quot;:&quot;3&quot;
}
</code></pre>
<h2 id="51-aidcid">5.1 aid和cid</h2>
<pre><code class="language-python"># 正常app也是可以返回aid和cid的，但是之前在web端破解过这个，我们因为要刷自己的视频，地址是知道的，所以直接获得即可
import requests
import json
import re

header = {
    'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36'
}
res = requests.get(&quot;https://www.bilibili.com/video/BV1bg4y1D7aJ/?spm_id_from=333.337.search-card.all.click&quot;,
                   headers=header)

data_list = re.findall(r'var options = (.+);', res.text)

data_dict = json.loads(data_list[0])
aid = data_dict['aid']
cid = data_dict['cid']
print(aid)
print(cid)

</code></pre>
<h2 id="52-did">5.2 参数did</h2>
<pre><code class="language-python"># 1 找到did位置：treeMap.put(&quot;did&quot;, com.bilibili.lib.biliid.utils.f.a.c(f2));
# 2 看源码，找到c
public static String c(@Nullable Context context) {
    # 1 判断变量是否有值，如果有值，直接返回了，没有值，继续往下走
    # 先从变量的内存中取，如果取不到--》去xml中读--》再取不到就生成一个，放到xml中和变量中
    if (TextUtils.isEmpty(f13201c)) {
        if (context == null) {
            return &quot;&quot;;
        }
        # 2 去xml中毒
        String f = c2.f.b0.c.a.e.k().f(context);
        f13201c = f;
        if (!TextUtils.isEmpty(f)) {
            return f13201c;
        }
        # 3 内存，xml中都没有，通过g生成，生成后
        # 赋值给了变量，放在内存中了
        f13201c = g(context);
        # 放在了xml中
        c2.f.b0.c.a.e.k().x(f13201c, context);
        return f13201c;
    }
    return f13201c;
}

# 3 咱们 g如何生成的
static String g(Context context) {
    # 1 通过调用f生成 f字符串
    String f = f(context);
    #2 如果生成的字符串长度小于4，又使用Settings.Secure.getString方案生成
    if (f.length() &lt; 4) {
        f = Settings.Secure.getString(context.getContentResolver(), &quot;android_id&quot;) + &quot;@&quot; + g.g(Build.MODEL);
    }
    # 3 调用b生成，并返回
    return b(f);
}

# 4 看f(context)
# 本质：mac地址|蓝牙地址|设备总线|sn号
public static String f(Context context) {
    StringBuffer stringBuffer = new StringBuffer();
    String j2 = j(context); # wlan.lge.wifimac  mac地址 可以伪造
    if (j2 != null) {
        String lowerCase = j2.replaceAll(&quot;[^0-9A-Fa-f]&quot;, &quot;&quot;).toLowerCase();
        if (k(lowerCase)) {
            stringBuffer.append(lowerCase);
        }
    }
    stringBuffer.append('|');
    String a2 = z.a(&quot;persist.service.bdroid.bdaddr&quot;); # 蓝牙地址
    if (a2.length() &gt; 0) {
        String lowerCase2 = a2.replaceAll(&quot;[^0-9A-Fa-f]&quot;, &quot;&quot;).toLowerCase();
        if (k(lowerCase2)) {
            stringBuffer.append(lowerCase2);
        }
    }
    stringBuffer.append('|');
    String h = h(); # 设备总线
    if (h != null) {
        stringBuffer.append(h.toLowerCase());
    }
    stringBuffer.append('|');
    String i = i(); # sn号
    if (i != null) {
        stringBuffer.append(i.toLowerCase());
    }
    return stringBuffer.toString();
}

#5  把 mac地址|蓝牙地址|设备总线|sn号 拼成字符串
# 6 看b做了什么 b(mac地址|蓝牙地址|设备总线|sn号 拼成字符串)
# 使用python一步一步复现--》使用chatgpt实现
public static String b(String str) {
    byte[] bytes = str.getBytes();
    bytes[0] = (byte) (bytes[0] ^ ((byte) (bytes.length &amp; 255)));
    for (int i = 1; i &lt; bytes.length; i++) {
        bytes[i] = (byte) ((bytes[i - 1] ^ bytes[i]) &amp; 255);
    }
    try {
        return new String(Base64.encode(bytes, 11));
    } catch (Exception unused) {
        return str;
    }
}

</code></pre>
<h3 id="521-hook-fdid-">5.2.1 hook--》f拿到did--&gt;清除所有数据</h3>
<pre><code class="language-python">import frida
import sys

rdev = frida.get_remote_device()
session = rdev.attach(&quot;tv.danmaku.bili&quot;)

scr = &quot;&quot;&quot;
Java.perform(function () {
    var didCls = Java.use(&quot;com.bilibili.lib.biliid.utils.f.a&quot;);

    didCls.f.implementation = function(arg5){
        var res = this.f(arg5);
        console.log(&quot;生成的did = &quot;,res);
        return res;
    }    

});
&quot;&quot;&quot;
script = session.create_script(scr)


def on_message(message, data):
    print(message, data)


script.on(&quot;message&quot;, on_message)
script.load()
sys.stdin.read()

# hook发现为：|||
# 或
</code></pre>
<pre><code class="language-python">import frida
import sys

rdev = frida.get_remote_device()
pid = rdev.spawn([&quot;tv.danmaku.bili&quot;]) # 如果是spawn方案，必须写包名，放到列表中
session = rdev.attach(pid)


scr = &quot;&quot;&quot;
Java.perform(function () {
    var didCls = Java.use(&quot;com.bilibili.lib.biliid.utils.f.a&quot;);

    didCls.f.implementation = function(arg5){
        var res = this.f(arg5);
        console.log(&quot;生成的did = &quot;,res);
        return res;
    }    

});
&quot;&quot;&quot;

script = session.create_script(scr)
def on_message(message, data):
    print(message, data)
script.on(&quot;message&quot;, on_message)
script.load()
rdev.resume(pid)
sys.stdin.read()

'''
hook到的是：|||
'''
</code></pre>
<h3 id="53-macsn">5.3 生成字符串（mac地址|蓝牙地址|设备总线|sn号）</h3>
<h4 id="531-macsn">5.3.1 生成mac和sn</h4>
<pre><code class="language-python">import random
import string


def create_random_mac(sep=&quot;:&quot;):
    &quot;&quot;&quot; 随机生成mac地址 &quot;&quot;&quot;
    data_list = []
    for i in range(1, 7):
        part = &quot;&quot;.join(random.sample(&quot;0123456789ABCDEF&quot;, 2))
        data_list.append(part)
    mac = sep.join(data_list)
    return mac

def gen_sn():
    return &quot;&quot;.join(random.sample(&quot;123456789&quot; + string.ascii_lowercase, 10))


mac_string = create_random_mac(sep=&quot;&quot;)
sn = gen_sn()

prev_did = &quot;{}|||{}&quot;.format(mac_string, sn)
print(prev_did)
</code></pre>
<h3 id="54">5.4 位运算</h3>
<pre><code class="language-java">//b函数
public static String b(String str) {
    // 把传入的字符串变成字节
    byte[] bytes = str.getBytes();
    //https://zhuanlan.zhihu.com/p/370167569
    // &amp; 与运算  ^按位异或
    //bytes[0] = bytes[0] ^ (bytes.length &amp; 255);
    bytes[0] = (byte) (bytes[0] ^ ((byte) (bytes.length &amp; 255)));
    for (int i = 1; i &lt; bytes.length; i++) {
        bytes[i] = (byte) ((bytes[i - 1] ^ bytes[i]) &amp; 255);
    }
    try {
        //转成base64返回
        return new String(Base64.encode(bytes, 11));
    } catch (Exception unused) {
        return str;
    }
}
</code></pre>
<h4 id="541-python">5.4.1 python实现</h4>
<pre><code class="language-python">import random
import string
import base64

def base64_encrypt(data_string):
    data_bytes = bytearray(data_string.encode('utf-8'))
    data_bytes[0] = data_bytes[0] ^ (len(data_bytes) &amp; 0xFF)
    for i in range(1, len(data_bytes)):
        data_bytes[i] = (data_bytes[i - 1] ^ data_bytes[i]) &amp; 0xFF
    res = base64.encodebytes(bytes(data_bytes))
    return res.strip().strip(b&quot;==&quot;).decode('utf-8')
</code></pre>
<h1 id="6">6 代码整合</h1>
<pre><code class="language-python">import random
import string
import base64
import time
import re
import json
import requests
import hashlib

from Crypto.Cipher import AES
from Crypto.Util.Padding import pad


def base64_encrypt(data_string):
    data_bytes = bytearray(data_string.encode('utf-8'))
    data_bytes[0] = data_bytes[0] ^ (len(data_bytes) &amp; 0xFF)
    for i in range(1, len(data_bytes)):
        data_bytes[i] = (data_bytes[i - 1] ^ data_bytes[i]) &amp; 0xFF
    res = base64.encodebytes(bytes(data_bytes))
    return res.strip().strip(b&quot;==&quot;).decode('utf-8')


def create_random_mac(sep=&quot;:&quot;):
    &quot;&quot;&quot; 随机生成mac地址 &quot;&quot;&quot;
    data_list = []
    for i in range(1, 7):
        part = &quot;&quot;.join(random.sample(&quot;0123456789ABCDEF&quot;, 2))
        data_list.append(part)
    mac = sep.join(data_list)
    return mac


def gen_sn():
    return &quot;&quot;.join(random.sample(&quot;123456789&quot; + string.ascii_lowercase, 10))


mac_string = create_random_mac(sep=&quot;&quot;)

did = base64_encrypt(f&quot;{mac_string}|||&quot;)

header = {
    'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36'
}
res = requests.get(&quot;https://www.bilibili.com/video/BV1bg4y1D7aJ/?spm_id_from=333.337.search-card.all.click&quot;,
                   headers=header)

data_list = re.findall(r'var options = (.+);', res.text)

data_dict = json.loads(data_list[0])
aid = data_dict['aid']
cid = data_dict['cid']

# 1.明文参数
data_dict = {
    &quot;aid&quot;: aid,
    &quot;auto_play&quot;: &quot;0&quot;,
    &quot;build&quot;: &quot;6240300&quot;,
    &quot;cid&quot;: cid,
    &quot;did&quot;: did,
    &quot;epid&quot;: &quot;&quot;,
    &quot;from_spmid&quot;: &quot;main.ugc-video-detail.0.0&quot;,
    &quot;ftime&quot;: str(int(time.time() - random.randint(100, 5000))),
    &quot;lv&quot;: &quot;0&quot;,
    &quot;mid&quot;: &quot;0&quot;,
    &quot;mobi_app&quot;: &quot;android&quot;,
    &quot;part&quot;: &quot;1&quot;,
    &quot;sid&quot;: &quot;0&quot;,
    &quot;spmid&quot;: &quot;main.ugc-video-detail.0.0&quot;,
    &quot;stime&quot;: str(int(time.time())),
    &quot;sub_type&quot;: &quot;0&quot;,
    &quot;type&quot;: &quot;3&quot;
}

# 2.sign签名
v1 = &quot;&amp;&quot;.join([f&quot;{key}={data_dict[key]}&quot; for key in sorted(data_dict)])
salt = &quot;9cafa6466a028bfb&quot;
obj = hashlib.sha256()
obj.update(v1.encode('utf-8'))
obj.update(salt.encode('utf-8'))

sign_string = obj.hexdigest()
print(sign_string)

data_string = f&quot;{v1}&amp;sign={sign_string}&quot;

# 3.AES加密

KEY = &quot;fd6b639dbcff0c2a1b03b389ec763c4b&quot;
IV = &quot;77b07a672d57d64c&quot;

aes = AES.new(
    key=KEY.encode('utf-8'),
    mode=AES.MODE_CBC,
    iv=IV.encode('utf-8')
)
bytes_data = pad(data_string.encode('utf-8'), 16)

result = [item for item in bytes_data]
print(result)

</code></pre>


</section>
</div> <!-- end of search-noresults -->
<div class="search-results">
<div class="has-results">

<h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
<ul class="search-results-list"></ul>

</div> <!-- end of has-results -->
<div class="no-results">

<h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>

</div> <!-- end of no-results -->
</div> <!-- end of search-results -->
</div> <!-- end of book-search-results -->

</div> <!-- end of page-inner -->
</div> <!-- end of page-wrapper -->

</div> <!-- end of body-inner -->

</div> <!-- end of book-body -->
<script src="../js/main.js"></script>
<script src="../search/main.js"></script>
<script src="../js/gitbook.min.js"></script>
<script src="../js/theme.min.js"></script>
</body>
</html>