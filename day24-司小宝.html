<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<title>二十四、司小宝 - App逆向在线笔记</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="generator" content="mkdocs-1.6.1, mkdocs-gitbook-1.0.7">

<link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">
<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta rel="next" href="" />
<link href="./css/style.min.css" rel="stylesheet"> 
</head>

<body>
<div class="book">
<div class="book-summary">
<div id="book-search-input" role="search">
<input type="text" placeholder="Type to search" />
</div> <!-- end of book-search-input -->

<nav role="navigation">
<ul class="summary">
<li>
<a href="index.html" target="_blank" class="custom-link">App逆向在线笔记</a>
</li>
<li class="divider"></li>
<li class="chapter" data-path="index.html">
<a href="index.html">Welcome to Lucky App逆向</a>
<li class="chapter" data-path="day01-%E5%BC%80%E7%8F%AD.html">
<a href="day01-%E5%BC%80%E7%8F%AD.html">一、前期准备</a>
<li class="chapter" data-path="day02-adb.html">
<a href="day02-adb.html">二、adb</a>
<li class="chapter" data-path="day03-%E6%8A%93%E5%8C%85%E5%92%8C%E5%8F%8D%E7%BC%96%E8%AF%91.html">
<a href="day03-%E6%8A%93%E5%8C%85%E5%92%8C%E5%8F%8D%E7%BC%96%E8%AF%91.html">三、抓包和反编译</a>
<li class="chapter" data-path="day04-hook-%E5%B8%B8%E7%94%A8%E5%8A%A0%E5%AF%86-%E6%8A%93%E5%8C%85app.html">
<a href="day04-hook-%E5%B8%B8%E7%94%A8%E5%8A%A0%E5%AF%86-%E6%8A%93%E5%8C%85app.html">四、hook-常用加密-抓包app</a>
<li class="chapter" data-path="day05-%E9%80%86x%E6%A1%88%E4%BE%8B.html">
<a href="day05-%E9%80%86x%E6%A1%88%E4%BE%8B.html">五、抓包和逆向案例</a>
<li class="chapter" data-path="day06-java%E5%9F%BA%E7%A1%8001.html">
<a href="day06-java%E5%9F%BA%E7%A1%8001.html">六、java基础-01</a>
<li class="chapter" data-path="day07-java%E5%9F%BA%E7%A1%8002.html">
<a href="day07-java%E5%9F%BA%E7%A1%8002.html">七、java基础02</a>
<li class="chapter" data-path="day08-java%E5%9F%BA%E7%A1%8003.html">
<a href="day08-java%E5%9F%BA%E7%A1%8003.html">八、java基础03</a>
<li class="chapter" data-path="day09-%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%9101.html">
<a href="day09-%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%9101.html">Day09 安卓开发01</a>
<li class="chapter" data-path="day10-%E5%AE%89%E5%8D%93%E5%9F%BA%E7%A1%8002.html">
<a href="day10-%E5%AE%89%E5%8D%93%E5%9F%BA%E7%A1%8002.html">十、安卓开发02</a>
<li class="chapter" data-path="day10%E5%AE%89%E5%8D%93%E5%9F%BA%E7%A1%80%E5%8A%A0%E5%AF%86%E6%8B%A6%E6%88%AA%E5%99%A8.html">
<a href="day10%E5%AE%89%E5%8D%93%E5%9F%BA%E7%A1%80%E5%8A%A0%E5%AF%86%E6%8B%A6%E6%88%AA%E5%99%A8.html">十、安卓基础加密拦截器</a>
<li class="chapter" data-path="day11-C%E8%AF%AD%E8%A8%80%E5%AE%89%E8%A3%85.html">
<a href="day11-C%E8%AF%AD%E8%A8%80%E5%AE%89%E8%A3%85.html">十一、C语言安装与入门</a>
<li class="chapter" data-path="day12-C%E8%AF%AD%E8%A8%80%E5%92%8CJNI%E5%BC%80%E5%8F%91.html">
<a href="day12-C%E8%AF%AD%E8%A8%80%E5%92%8CJNI%E5%BC%80%E5%8F%91.html">十二、C语言和JNI开发</a>
<li class="chapter" data-path="day13-JNI%E5%BC%80%E5%8F%91.html">
<a href="day13-JNI%E5%BC%80%E5%8F%91.html">十三、JNI开发</a>
<li class="chapter" data-path="day14-%E8%BD%A6%E6%99%BA%E8%B5%A2.html">
<a href="day14-%E8%BD%A6%E6%99%BA%E8%B5%A2.html">十四、车智赢</a>
<li class="chapter" data-path="day15-%E8%AF%86%E8%B4%A7app.html">
<a href="day15-%E8%AF%86%E8%B4%A7app.html">十五、识货app</a>
<li class="chapter" data-path="day16-%E5%BE%97%E7%89%A9app.html">
<a href="day16-%E5%BE%97%E7%89%A9app.html">十六、得物app</a>
<li class="chapter" data-path="day17-B%E7%AB%99%E6%92%AD%E6%94%BE%E9%87%8Fday01.html">
<a href="day17-B%E7%AB%99%E6%92%AD%E6%94%BE%E9%87%8Fday01.html">十七、B站播放量day01</a>
<li class="chapter" data-path="day18-B%E7%AB%9902.html">
<a href="day18-B%E7%AB%9902.html">十八、B站02</a>
<li class="chapter" data-path="day19-B%E7%AB%9903.html">
<a href="day19-B%E7%AB%9903.html">十九、B站02</a>
<li class="chapter" data-path="day20-%E5%94%AF%E5%93%81%E4%BC%9A01.html">
<a href="day20-%E5%94%AF%E5%93%81%E4%BC%9A01.html">二十、唯品会01</a>
<li class="chapter" data-path="day21-%E5%94%AF%E5%93%81%E4%BC%9A02.html">
<a href="day21-%E5%94%AF%E5%93%81%E4%BC%9A02.html">二十一、唯品会02</a>
<li class="chapter" data-path="day22-DYM.html">
<a href="day22-DYM.html">二十二、DYM</a>
<li class="chapter" data-path="day23-%E9%85%92%E4%BB%99%E7%BD%91.html">
<a href="day23-%E9%85%92%E4%BB%99%E7%BD%91.html">二十三、酒仙网</a>
<li class="chapter active" data-path="day24-%E5%8F%B8%E5%B0%8F%E5%AE%9D.html">
<a href="day24-%E5%8F%B8%E5%B0%8F%E5%AE%9D.html">二十四、司小宝</a>
<li class="chapter" data-path="day25-unidbg-%E4%B8%8A.html">
<a href="day25-unidbg-%E4%B8%8A.html">二十五、unidbg-上</a>
<li class="chapter" data-path="day26-unidbg-%E4%B8%AD%E7%AF%87.html">
<a href="day26-unidbg-%E4%B8%AD%E7%AF%87.html">二十六、unidbg-中</a>
<li class="chapter" data-path="day27-unidbg-%E4%B8%8B.html">
<a href="day27-unidbg-%E4%B8%8B.html">二十七、unidbg-下</a>
<li class="chapter" data-path="day28-xhs-%E4%B8%8A.html">
<a href="day28-xhs-%E4%B8%8A.html">二十八、xhs-上</a>
<li class="chapter" data-path="day29-xhs-%E4%B8%8B.html">
<a href="day29-xhs-%E4%B8%8B.html">二十九、xhs-下</a>
<li class="chapter" data-path="day30-%E6%97%A0%E9%9A%9C%E7%A2%8D.html">
<a href="day30-%E6%97%A0%E9%9A%9C%E7%A2%8D.html">三十、无障碍开发</a>
<li class="chapter" data-path="day31-%E6%97%A0%E9%9A%9C%E7%A2%8D.html">
<a href="day31-%E6%97%A0%E9%9A%9C%E7%A2%8D.html">三十一、无障碍image-20240703160302051</a>
<li class="chapter" data-path="day32-%E6%97%A0%E9%9A%9C%E7%A2%8D%E9%83%A8%E7%BD%B2.html">
<a href="day32-%E6%97%A0%E9%9A%9C%E7%A2%8D%E9%83%A8%E7%BD%B2.html">三十二、无障碍项目部署</a>
<li class="divider"></li>



<li><a href="http://www.mkdocs.org">
Published with MkDocs
</a></li>

<li><a href="https://github.com/GitbookIO/theme-default">
Theme by GitBook
</a></li>
</ul>

</nav>

</div> <!-- end of book-summary -->

<div class="book-body">
<div class="body-inner">
<div class="book-header" role="navigation">

<!-- Title -->
<h1>
<i class="fa fa-circle-o-notch fa-spin"></i>
<a href="." ></a>
</h1>

</div> <!-- end of book-header -->

<div class="page-wrapper" tabindex="-1" role="main">
<div class="page-inner">
<div id="book-search-results">
<div class="search-noresults">

<section class="normal markdown-section">



<h1 id="_1">二十四、司小宝</h1>
<h1 id="_2">一 目标</h1>
<p>目的：手机号+密码 自动登录。</p>
<p>版本：司小宝v4.0.9</p>
<h1 id="_3">二 抓包</h1>
<pre><code class="language-python">设置代理后，如果抓不到包，使用SocketDroid转发即可
</code></pre>
<p><img alt="image-20230907170400344" src="imgs/day24-%E5%8F%B8%E5%B0%8F%E5%AE%9D.assets/image-20230907170400344.png" /></p>
<pre><code class="language-python">###### 分析
# 请求地址：
https://g7s.ucenter.huoyunren.com/inside.php

# 请求方式：
POST

# 请求头：
X-B3-TraceId:e0a82e5bee2945da9546e24c44f5756b # 可以删除不携带

# 请求体：
mobile                  #加密，需要破解
password                #加密，需要破解
equipment   google      #手机型号

# 请求参数：
t:json
m:mobileinfo
f:driverLogin
accessid:br278dj          # 固定，可以删除
g7timestamp:1694077461185
app:1
ua: android
appclientversion:4.0.9
referer:d507c00281c733bd693e5049ea33ad7e # 固定，可以删除
sign:RzHiBa7GIKSm2Zi8XtZMo43R+qg=  # 也可以删除


### 我们需要逆向的
- mobile 和 password
- sign
</code></pre>
<h2 id="31">3.1 抓包发送验证码</h2>
<pre><code class="language-python">#1 请求地址
    https://vega.huoyunren.com/v2/isnb-openapi-proxy/auth/router?
#2 请求方式
    post
#3 请求参数
    method  ntocc-contract.contract.sendVerificationCode # 地址
    phone   18953675221
    accessid    br278dj  # 固定，可以删除
    g7timestamp 1717754609665
    app 1
    ua  android
    appclientversion    4.7.8
    referer d507c00281c733bd693e5049ea33ad7e # 固定，可以删除
    sign    ctlWxQMoL5kUp8CJ/BEmwT2EnmY=

# 我们需要逆向的
- sign
</code></pre>
<h1 id="sign">三 逆向sign</h1>
<h2 id="31_1">3.1 步骤</h2>
<pre><code class="language-python"># 1 jadx 反编译，搜索--&gt;因为sign和g7timestamp都在请求参数中，它比较特殊，我们搜索：g7timestamp
# 2 点击第二个进入，往下拉，可以看到sign的位置
    sb.append(&quot;&amp;sign=&quot;);
    sb.append(new GatewaySign4Customer().a(EnvUtil.m37779d().f7738j, str2, valueOf, str));

# 3 查看 a
public class p0 {
    public String a(String str, String str2, String str3, String str4) {
        try {
            return Uri.encode(new s0().a(str, str2 + &quot;\n&quot; + str3 + &quot;\n/&quot; + str4));
        } catch (SignatureException unused) {
            throw new RuntimeException(&quot;sign failed&quot;);
        }
    }
}

# 4 尝试hook--查看入参


# 5 hook到后发现4个参数和返回值
# 四个参数，第一个不变，第二个是post请求，第三个是时间戳，第四个是 inside.php
1KMrg0dfufc0wpnXEJacEQX1YEUYA0Ja POST 1694450485059 inside.php
5VnGRNih2xWwXIF3QeuAYdD7j%2F4%3D


# 6 继续查看：new s0().a
class s0 {
    public String a(String str, String str2) throws SignatureException {
        try {
            SecretKeySpec secretKeySpec = new SecretKeySpec(str.getBytes(), &quot;HmacSHA1&quot;);
            Mac mac = Mac.getInstance(&quot;HmacSHA1&quot;);
            mac.init(secretKeySpec);
            return Base64.encodeToString(mac.doFinal(str2.getBytes(&quot;UTF-8&quot;)), 2);
        } catch (Exception e2) {
            throw new SignatureException(&quot;Failed to generate HMAC : &quot; + e2.getMessage());
        }
    }
}

# 7 使用HmacSHA1加密，key是第一个参数，是刚刚我们hook到的第一个参数：1KMrg0dfufc0wpnXEJacEQX1YEUYA0Ja
</code></pre>
<p><img alt="image-20230907171736681" src="imgs/day24-%E5%8F%B8%E5%B0%8F%E5%AE%9D.assets/image-20230907171736681.png" /></p>
<p><img alt="image-20230907171809921" src="imgs/day24-%E5%8F%B8%E5%B0%8F%E5%AE%9D.assets/image-20230907171809921.png" /></p>
<h2 id="32-hook-p0-a">3.2 hook--p0--a方法查看入参（失败）</h2>
<pre><code class="language-python">## js hook 脚本
Java.perform(function () {
    var p0 = Java.use(&quot;cmt.chinaway.com.lite.q.p0&quot;);
    p0.a.implementation = function (str, str2, str3,str4) {
        console.log(&quot;---------------------&quot;)
        console.log(str, str2, str3,str4);
        var res = this.a(str, str2, str3,str4);
        console.log(res);
        return res;
    };
});


#  attach 方案执行：frida -UF  -l  1-hook-p0-a.js
#  spawn 方案启动：frida -U -f cmt.chinaway.com.lite -l 1-hook-p0-a.js


# No frontmost application on Pixel 2 XL    app没有启动的话
# Failed to attach: process not found       hook不到


### python hook脚本
import frida
import sys
# 连接手机设备
rdev = frida.get_remote_device()
session = rdev.attach(&quot;司小宝&quot;)
scr = &quot;&quot;&quot;
Java.perform(function () {
    var p0 = Java.use(&quot;cmt.chinaway.com.lite.q.p0&quot;);
    p0.a.implementation = function (str, str2, str3,str4) {
        console.log(&quot;---------------------&quot;)
        console.log(str, str2, str3,str4);
        var res = this.a(str, str2, str3,str4);
        console.log(res);
        return res;
    };
});
&quot;&quot;&quot;

script = session.create_script(scr)

def on_message(message, data):
    print(message, data)

script.on(&quot;message&quot;, on_message)
script.load()
sys.stdin.read()


#  unable to find process with name '司小宝'   没开启app报错
#  frida.ProcessNotFoundError: process not found  hook不到报错
#  unable to access process with pid 17124 due to system restrictions; try `sudo sysctl kernel.yama.ptrace_scope=0`, or run Frida as root
</code></pre>
<h2 id="33-hook-">3.3 我们hook-车智赢</h2>
<pre><code class="language-python">### 查看手机上正在运行的所有应用
frida-ps -U -a
# 找到车智赢的进程id
21678  车智赢+        com.che168.autotradercloud

import frida
import sys

# 连接手机设备
rdev = frida.get_remote_device()
session = rdev.attach(21678)
scr = &quot;&quot;&quot;
Java.perform(function () {
    // 包.类
    var SecurityUtil = Java.use(&quot;com.autohome.ahkit.utils.SecurityUtil&quot;);
    SecurityUtil.encodeMD5.implementation = function(str){
        console.log(&quot;明文：&quot;,str);
        var res = this.encodeMD5(str);
        console.log(&quot;md5加密结果=&quot;,res);
        return &quot;305eb636-eb15-4e24-a29d-9fd60fbc91bf&quot;;
    }
});
&quot;&quot;&quot;

script = session.create_script(scr)


def on_message(message, data):
    print(message, data)


script.on(&quot;message&quot;, on_message)
script.load()
sys.stdin.read()
</code></pre>
<h2 id="34-ptrace">3.4 ptrace占坑</h2>
<p>这是<strong>ptrace占坑</strong>的标志。</p>
<p>ptrace可以让一个进程监视和控制另一个进程的执行,并且修改被监视进程的内存、寄存器等,主要应用于调试器的断点调试、系统调用跟踪等。</p>
<p>在Android app保护中,ptrace被广泛用于反调试。一个进程只能被ptrace一次,如果先调用了ptrace方法,那就可以防止别人调试我们的程序。这就是传说中的先占坑。</p>
<p>一个进程只能被一个进程附加，为了防止frida的附加，程序中自己先基于ptrace附加自己，我们如果后期使用frida去附加app时，就会报错了。</p>
<p>frida内部会使用ptrace。</p>
<pre><code class="language-python">ps -A |grep lite
ps -e |grep lite
</code></pre>
<p><img alt="image-20230912003432089" src="imgs/day24-%E5%8F%B8%E5%B0%8F%E5%AE%9D.assets/image-20230912003432089.png" /></p>
<pre><code class="language-python">## 如何查看这个app，是不是被占坑了
    -查看手机正在运行的进程，【需要在手机上执行  adb shell 进入到手机】
    ps -A |grep 车智赢包名
    ps -A |grep autotradercloud  # 只过滤车智赢的进程

    ps -A |grep lite  # 只过司小宝的进程
    # 忽略掉带 :  结果，如果发现有两条记录，咱们就可以断定它使用了ptrace占坑


## 查看当前手机正在运行的应用
    正在运行的应用和正在运行的进程不是一个概念
    手机端开启frida-server
    在电脑上执行
    # frida-ps -U -a
    可以看到 车智赢在运行
     com.che168.autotradercloud



## hook应用时候，可以用应用名字，也可以用应用进程id号
# session = rdev.attach('车智赢+')
session = rdev.attach(9894) # 这个app在手机中的进程id号--》使用命令查看到

## 如何解决 ptrace占坑
    - 0 通过杀进程方案---》导致真正的进程也会被关掉---》如果是这种app，就没法用这种方式
        司小宝---》kill -9 ptrace占坑的进程 skb_recv_xxx---》打开司小宝---》发现只有一个主进程了--》没有ptrace占坑进程了----》hook就可以正常用


    -1 开启app--》自动起一个进程---》占坑---》使用spawn方案hook---》让hook脚本早于它占坑的进程执行---》它占坑的进程就起不来
        使用spawn方案就可以解决这个问题

    -2 后期学习 aosp刷机，修改aosp源码---》让app自己附加的进程都启动失败--》编译后刷入到手机中，就可以避免这个问题
</code></pre>
<h3 id="341-ptrace">3.4.1 解决ptrace占坑</h3>
<ul>
<li>方法1：速度快点让frida先附加(使用spawn方案运行)。</li>
</ul>
<p><code>frida -U -f cmt.chinaway.com.lite -l 111.js</code></p>
<ul>
<li>方法2：修改AOSP源码，让它自己附加自己失败，编译并刷入自己手机。</li>
</ul>
<p><code>bionic/libc/bionic/ptrace.cpp</code></p>
<p>```c
    bool is_peek = (req == PTRACE_PEEKUSR || req == PTRACE_PEEKTEXT || req == PTRACE_PEEKDATA);
    long peek_result;</p>
<pre><code>va_list args;
va_start(args, req);
pid_t pid = va_arg(args, pid_t);
void* addr = va_arg(args, void*);
void* data;
if (is_peek) {
  data = &amp;peek_result;
} else {
  data = va_arg(args, void*);
}
va_end(args);



///ADD START
int caller_uid=getuid();

//int caller_pid=getpid();
//caller_uid&gt;10000说明是普通App调用
if(caller_uid&gt;10000)
{

   if(req ==PTRACE_TRACEME)
   {
      //自己ptrace自己,直接返回成功
      return 0;
   }
 if(req==PTRACE_ATTACH)
 {
   int caller_ppid=getppid();
   if(caller_ppid==pid)
   {
      //如果是子进程ptrace父进程，直接返回成功
      return 0;
   }
   //也可以通过读取/proc/$pid/status获取进程的uid
   //如果uid和当前调用ptrace的uid一致，也直接返回成功
 }
}
///ADD END
long result = __ptrace(req, pid, addr, data);
if (is_peek &amp;&amp; result == 0) {
  return peek_result;
}
return result;
</code></pre>
<p>}
  ```</p>
<p>## hook成功</p>
<p>```js
  Java.perform(function () {
      var p0 = Java.use("cmt.chinaway.com.lite.q.p0");
      p0.a.implementation = function (str, str2, str3,str4) {
          console.log("---------------------")
          console.log(str, str2, str3,str4);
          var res = this.a(str, str2, str3,str4);
          console.log(res);
          return res;
      };
  });</p>
<p>// 使用spawn方案hook---
  frida -U -f cmt.chinaway.com.lite -l 111.js</p>
<p>/*
  四个参数，第一个不变，第二个是post请求，第三个是时间戳，第四个是 inside.php
  1KMrg0dfufc0wpnXEJacEQX1YEUYA0Ja POST 1694450485059 inside.php
  5VnGRNih2xWwXIF3QeuAYdD7j%2F4%3D</p>
<hr />
<p>1KMrg0dfufc0wpnXEJacEQX1YEUYA0Ja POST 1694450485061 inside.php
  B6YjwYF02I2NsLEydxcwFJBemH0%3D</p>
<p>*/
  ```</p>
<h2 id="35-sign">3.5 代码实现sign</h2>
<pre><code class="language-python">import base64
import hashlib
import hmac
from urllib.parse import quote_plus

key = &quot;1KMrg0dfufc0wpnXEJacEQX1YEUYA0Ja&quot;
message = &quot;&quot;&quot;POST
1694450485059
/inside.php&quot;&quot;&quot;
message = message.encode('utf-8')  # 加密内容
key = key.encode('utf-8')  # 加密的key
result = hmac.new(key, message, hashlib.sha1).digest()
print(result)
_sig = base64.b64encode(result).decode()
print(_sig)

result = quote_plus(_sig)
print(result)
</code></pre>
<h1 id="_4">四 逆向手机号和密码(旧版本不能用了)</h1>
<h2 id="41">4.1 步骤</h2>
<pre><code class="language-python"># 1 反编译，搜索 &quot;password&quot;
# 2 查看跟 LoginResponseEntity 相关，进入，发现使用了retrofit2发送请求
# 3 查找用例，虽然有好几个，但是第二个参数，也就是password都是用 n1.a(obj)

# 4 我们直接hook n1的a方法--&gt;发现位置正确

# 5 我们查看n1的a方法---》使用rsa加密后，用base64编码，调用c方法
# 公钥是调用b()得到的
public static String a(String str) throws Exception {
    byte[] doFinal;
    byte[] bytes = str.getBytes(&quot;utf-8&quot;);
    PublicKey b = b();
    Cipher cipher = Cipher.getInstance(&quot;RSA/ECB/PKCS1Padding&quot;);
    cipher.init(1, b);
    int length = bytes.length;
    ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
    int i = 0;
    int i2 = 0;
    while (true) {
        int i3 = length - i;
        if (i3 &gt; 0) {
            if (i3 &gt; 117) {
                doFinal = cipher.doFinal(bytes, i, 117);
            } else {
                doFinal = cipher.doFinal(bytes, i, i3);
            }
            byteArrayOutputStream.write(doFinal, 0, doFinal.length);
            i2++;
            i = i2 * 117;
        } else {
            byte[] byteArray = byteArrayOutputStream.toByteArray();
            byteArrayOutputStream.close();
            return c(Base64.encodeToString(byteArray, 0).replace(&quot;\n&quot;, &quot;&quot;));
        }
    }
}
# 6 我们查看c方法--》把传入的字符串做与运算后右移

private static String c(String str) {
    byte[] bytes;
    char[] charArray = &quot;0123456789ABCDEF&quot;.toCharArray();
    StringBuilder sb = new StringBuilder(&quot;&quot;);
    for (byte b : str.getBytes()) {
        sb.append(charArray[(b &amp; 240) &gt;&gt; 4]);
        sb.append(charArray[b &amp; 15]);
    }
    return sb.toString().trim();
}
# 7 我们使用python复现
</code></pre>
<p><img alt="image-20230912005210717" src="imgs/day24-%E5%8F%B8%E5%B0%8F%E5%AE%9D.assets/image-20230912005210717.png" /></p>
<p><img alt="image-20230912005341572" src="imgs/day24-%E5%8F%B8%E5%B0%8F%E5%AE%9D.assets/image-20230912005341572.png" /></p>
<p><img alt="image-20230912005450995" src="imgs/day24-%E5%8F%B8%E5%B0%8F%E5%AE%9D.assets/image-20230912005450995.png" /></p>
<p><img alt="image-20230912005832961" src="imgs/day24-%E5%8F%B8%E5%B0%8F%E5%AE%9D.assets/image-20230912005832961.png" /></p>
<h2 id="42-hook-n1-a">4.2 hook-n1-a方法</h2>
<pre><code class="language-js">function hook_RegisterNatives() {
    Java.perform(function () {
        var n1 = Java.use(&quot;cmt.chinaway.com.lite.q.n1&quot;);
        n1.a.implementation = function (str) {
            console.log(&quot;---------------------&quot;)
            console.log(str);
            var res = this.a(str);
            console.log(res);
            return res;
        };
    });
}

setImmediate(hook_RegisterNatives);

// frida -U -f cmt.chinaway.com.lite -l  hook_pass.js

/*

18953675221
4F36736A636C594F7355542F746235696C4D6562385741327366615A69794A306973304274476730303034373774543453385533676C47784579594E7237413046636A6662494C675A37464B5649304D6948
3747666F326B736D422F34394144554A505037764775674F74775836323074774F78314249613055423568496A61745A4368686F736D534B6864506559784F4B372B4D596F7A78654D6E4C52574263695335467554614B6A493D
---------------------
lqz12345
6C357A49494A4E5746724136356537585856464D3050716B4B6651514A513476726C53416447455050617A4D58624368765756634345733046535079787A49455342686F346A4A4258572B6F2F73514F556D
7377635374614E6F6A7639304F393256372F7836534B554F745A6278547171304B51782F31645A4B5A42316E2B746757496473356B4945516F3867366A304A6D464166394C325751424E6D687A397745795235555565564C673D

 */
</code></pre>
<h2 id="43">4.3 用户名和密码加密方式</h2>
<pre><code class="language-python">from Crypto.PublicKey import RSA
from Crypto.Util.Padding import pad
from Crypto.Cipher import PKCS1_v1_5, AES
from base64 import b64encode


def c(data_text):
    array = &quot;0123456789ABCDEF&quot;
    data_list = []
    for b in data_text.encode('utf-8'):
        data_list.append(array[(b &amp; 240) &gt;&gt; 4])
        data_list.append(array[b &amp; 15])
    return &quot;&quot;.join(data_list)


data = &quot;18953675221&quot;

rsa_pub_key = &quot;&quot;&quot;-----BEGIN PUBLIC KEY-----
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCsAwGz+E7PEppCUWrM46wf9Sj2Zv+dlSIjwGtMoG9iG36HFYy0BC+uAgNDun0joo4UFW0qejyc2ExjFXBRiYENnseY3jb9qI0c3thAj2qd5iofGCWaRO1DA707xwD7MOjvHur7c7nvBNv+vwWFvMDiZzj4JqaaV8ZNTT2oO9+aJQIDAQAB
-----END PUBLIC KEY-----&quot;&quot;&quot;
key = RSA.importKey(rsa_pub_key)
cipher = PKCS1_v1_5.new(key)
encrypt_bytes = cipher.encrypt(data.encode('utf-8'))
cipher_text = b64encode(encrypt_bytes).decode('utf-8')
cipher_text = cipher_text.replace(r&quot;\n&quot;, &quot;&quot;)


result = c(cipher_text)
print(result)
</code></pre>
<h1 id="_5">五 代码整合</h1>
<pre><code class="language-python">import time
import requests
import base64
import hashlib
import hmac
from urllib.parse import quote_plus
from Crypto.PublicKey import RSA
from Crypto.Util.Padding import pad
from Crypto.Cipher import PKCS1_v1_5, AES
from base64 import b64encode


def sign(g7timestamp):
    key = &quot;1KMrg0dfufc0wpnXEJacEQX1YEUYA0Ja&quot;
    message = &quot;&quot;&quot;POST
    {}
    /inside.php&quot;&quot;&quot;.format(g7timestamp)
    message = message.encode('utf-8')
    key = key.encode('utf-8')
    result = hmac.new(key, message, hashlib.sha1).digest()
    _sig = base64.b64encode(result).decode()
    return quote_plus(_sig)


def encrypt(data_string):
    def c(data_text):
        array = &quot;0123456789ABCDEF&quot;
        data_list = []
        for b in data_text.encode('utf-8'):
            data_list.append(array[(b &amp; 240) &gt;&gt; 4])
            data_list.append(array[b &amp; 15])
        return &quot;&quot;.join(data_list)

    rsa_pub_key = &quot;&quot;&quot;-----BEGIN PUBLIC KEY-----
    MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCsAwGz+E7PEppCUWrM46wf9Sj2Zv+dlSIjwGtMoG9iG36HFYy0BC+uAgNDun0joo4UFW0qejyc2ExjFXBRiYENnseY3jb9qI0c3thAj2qd5iofGCWaRO1DA707xwD7MOjvHur7c7nvBNv+vwWFvMDiZzj4JqaaV8ZNTT2oO9+aJQIDAQAB
    -----END PUBLIC KEY-----&quot;&quot;&quot;
    key = RSA.importKey(rsa_pub_key)
    cipher = PKCS1_v1_5.new(key)
    encrypt_bytes = cipher.encrypt(data_string.encode('utf-8'))
    cipher_text = b64encode(encrypt_bytes).decode('utf-8')
    cipher_text = cipher_text.replace(r&quot;\n&quot;, &quot;&quot;)
    result = c(cipher_text)
    return result


def run():
    g7timestamp = str(int(time.time() * 1000))

    mobile = &quot;18953675221&quot;
    password = &quot;lqz12345&quot;

    param_dict = {
        &quot;t&quot;: &quot;json&quot;,
        &quot;m&quot;: &quot;mobileinfo&quot;,
        &quot;f&quot;: &quot;driverLogin&quot;,
        &quot;g7timestamp&quot;: g7timestamp,
        &quot;app&quot;: &quot;1&quot;,
        &quot;ua&quot;: &quot;android&quot;,
        &quot;appclientversion&quot;: &quot;4.0.9&quot;,
        &quot;referer&quot;: &quot;d507c00281c733bd693e5049ea33ad7e&quot;, # 固定的
        &quot;sign&quot;: sign(g7timestamp)
    }

    body_dict = {
        &quot;mobile&quot;: encrypt(mobile),
        &quot;password&quot;: encrypt(password),
        &quot;equipment&quot;: &quot;google&quot;
    }

    res = requests.post(
        url=&quot;https://g7s.ucenter.huoyunren.com/inside.php&quot;,
        params=param_dict,
        data=body_dict,
        verify=False
    )
    print(res.json())


if __name__ == '__main__':
    run()

</code></pre>
<h1 id="_6">四 验证码登录</h1>
<pre><code class="language-python"># 请求地址
    https://vega.huoyunren.com/v2/isnb-openapi-proxy/auth/router
# 请求方式
    post
# 请求参数
    method  ntocc-contract.contract.loginOrRegisterByPhoneAndCode
    accessid    br278dj
    g7timestamp 1717757672401
    app 1
    ua  android
    appclientversion    4.7.8
    referer d507c00281c733bd693e5049ea33ad7e
    sign    eNCcXpqaziBlAOG1Igt4SEI8BWc=   

# 请求体
    phone   18953675221
    captcha 6698
</code></pre>
<h1 id="_7">五 代码整合</h1>
<pre><code class="language-python">import time
import requests
import hmac
import base64
from hashlib import sha1

def sign(g7timestamp):
    try:
        secret_key=&quot;1KMrg0dfufc0wpnXEJacEQX1YEUYA0Ja&quot;
        content=f&quot;&quot;&quot;POST\n{g7timestamp}\n/v2/isnb-openapi-proxy/auth/router&quot;&quot;&quot;
        # 创建密钥
        secret_key = secret_key.encode()
        # 创建hmac对象，指定使用sha1算法
        mac = hmac.new(secret_key, digestmod=sha1)
        # 更新需要加密的消息
        mac.update(content.encode('utf-8'))
        # 生成HMAC并进行Base64编码
        hmac_result = mac.digest()
        base64_result = base64.b64encode(hmac_result)
        # 返回Base64编码后的结果
        return base64_result.decode()
    except Exception as e:
        raise Exception(f&quot;Failed to generate HMAC : {e}&quot;)
def send_code(mobile,g7timestamp,sign):
    param_dict = {
        'method': 'ntocc-contract.contract.sendVerificationCode',
        'phone': mobile,
        'accessid': 'br278dj',
        'g7timestamp': g7timestamp,
        'app': '1',
        'ua': 'android',
        'appclientversion': '4.7.8',
        'referer': 'd507c00281c733bd693e5049ea33ad7e',
        'sign': sign
    }


    res = requests.post(
        url=&quot;https://vega.huoyunren.com/v2/isnb-openapi-proxy/auth/router&quot;,
        params=param_dict,
        verify=False
    )
    print(res.url)
    print(res.text)


def login(mobile,code,g7timestamp,sign):
    param_dict = {
        'method': 'ntocc-contract.contract.loginOrRegisterByPhoneAndCode',
        'accessid': 'br278dj',
        'g7timestamp': g7timestamp,
        'app': '1',
        'ua': 'android',
        'appclientversion': '4.7.8',
        'referer': 'd507c00281c733bd693e5049ea33ad7e',
        'sign': sign
    }
    data={
        'phone':mobile,
        'captcha':code
    }
    res = requests.post(
        url=&quot;https://vega.huoyunren.com/v2/isnb-openapi-proxy/auth/router&quot;,
        params=param_dict,
        data=data,
        verify=False
    )
    print(res.url)
    print(res.text)

if __name__ == '__main__':
    mobile=input('输入手机号：')
    g7timestamp = str(int(time.time() * 1000))
    res=sign(g7timestamp)
    print(res)
    send_code(mobile,g7timestamp,res)
    code=input('输入验证码')
    g7timestamp = str(int(time.time() * 1000))
    res=sign(g7timestamp)
    print(res)
    login(mobile,code,g7timestamp,res)

</code></pre>
<h1 id="_8">六 免费代理搭建</h1>
<h2 id="61">6.1 搭建步骤</h2>
<pre><code class="language-python"># 地址为：https://github.com/jhao104/proxy_pool

#1 拉取代码
#2 pycharm打开
#3 安装依赖
#4 修改配置文件
    # setting.py 为项目配置文件
    # 配置API服务

    HOST = &quot;0.0.0.0&quot;               # IP
    PORT = 5000                    # 监听端口


    # 配置数据库
    DB_CONN = 'redis://127.0.0.1:6379/0'
    # 配置 ProxyFetcher
    PROXY_FETCHER = [
        &quot;freeProxy01&quot;,      # 这里是启用的代理抓取方法名，所有fetch方法位于fetcher/proxyFetcher.py
        &quot;freeProxy02&quot;,
        # ....
    ]

# 5 运行调度程序
# 启动调度程序
python proxyPool.py schedule
# 6 运行web服务

# 启动webApi服务
python proxyPool.py server
</code></pre>
<p><img alt="image-20230912012603659" src="imgs/day24-%E5%8F%B8%E5%B0%8F%E5%AE%9D.assets/image-20230912012603659.png" /></p>
<h1 id="mitmproxy">七 自定义代理工具mitmproxy</h1>
<h2 id="71">7.1 介绍</h2>
<pre><code class="language-python">#功能简介
实时拦截、修改 HTTP/HTTPS 请求和响应
可保存完整的 http 会话，方便后续分析和重放
支持反向代理模式将流量转发到指定服务器
支持用 Python 脚本对 HTTP 通信进行修改

## 官网
https://mitmproxy.org/

## mitmproxy跟charles区别
mitmproxy 就是用于 MITM 的 proxy，MITM 即中间人攻击（Man-in-the-middle attack）。用于中间人攻击的代理首先会向正常的代理一样转发请求，保障服务端与客户端的通信，其次，会适时的查、记录其截获的数据，或篡改数据，引发服务端或客户端特定的行为。

不同于 charles 抓包工具，mitmproxy 不仅可以截获请求帮助开发者查看、分析，更可以通过自定义脚本进行二次开发。举例来说，利用 charles 可以过滤出浏览器对某个特定 url 的请求，并查看、分析其数据，但实现不了高度定制化的需求，比如：“截获对浏览器对该 url 的请求，将返回内容置空，并将真实的返回内容存到某个数据库，出现异常时发出邮件通知”。而对于 mitmproxy，这样的需求可以通过载入自定义 python 脚本轻松实现。


</code></pre>
<p><img alt="image-20240220215731957" src="imgs/day24-%E5%8F%B8%E5%B0%8F%E5%AE%9D.assets/image-20240220215731957.png" /></p>
<h2 id="72">7.2 安装</h2>
<pre><code class="language-python">## 方式一：官网下载安装包，安装，一路下一步安装--》安装后安装路径自动加入环境变量
https://mitmproxy.org/


## 方式二：使用pip 安装
    pip3 install mitmproxy
</code></pre>
<p><img alt="image-20230912183203309" src="imgs/day24-%E5%8F%B8%E5%B0%8F%E5%AE%9D.assets/image-20230912183203309.png" /></p>
<p><img alt="image-20230912183328303" src="imgs/day24-%E5%8F%B8%E5%B0%8F%E5%AE%9D.assets/image-20230912183328303.png" /></p>
<h2 id="73">7.3 使用</h2>
<pre><code class="language-python"># 安装后 系统将拥有 mitmproxy、mitmdump、mitmweb 三个命令，由于 mitmproxy 命令不支持在 windows 系统中运行

#使用 mitmdump 测试一下安装是否成功
mitmdump --version
# 输出：
Mitmproxy: 10.0.0 binary
Python:    3.11.4
OpenSSL:   OpenSSL 3.0.7 1 Nov 2022
Platform:  Windows-10-10.0.22621-SP0




# 启动
    -mitmdump   # 命令窗口启动
    -mitmweb    # web页面启动

# 注意：
    - 分析请求包：推荐mitmweb
    - 命令行：推荐mitmdump + 代码
</code></pre>
<h2 id="74">7.4 手机配置代理+证书</h2>
<pre><code class="language-python">## 访问 mitm.it

## 只是手机配置代理，只能抓http包

## 需要安装证书，使用mitmproxy证书 + move cert + 重启
</code></pre>
<p><img alt="image-20230912184417219" src="imgs/day24-%E5%8F%B8%E5%B0%8F%E5%AE%9D.assets/image-20230912184417219.png" /></p>
<p><img alt="image-20230912184832431" src="imgs/day24-%E5%8F%B8%E5%B0%8F%E5%AE%9D.assets/image-20230912184832431.png" /></p>
<h2 id="75-pythonmitmproxy">7.5 python+mitmproxy</h2>
<h3 id="751">7.5.1 基本使用</h3>
<pre><code class="language-python">from mitmproxy import http


def request(flow: http.HTTPFlow):
    if flow.request.path == '/login.html':
        print(type(flow.request))  # mitmproxy.http.Request
        print(flow.request.path)
        print(flow.request.query)


def response(flow: http.HTTPFlow):
    if flow.request.path == '/login.html':
        print(type(flow.response))  # mitmproxy.http.Response
        print(flow.response.text)
        print(flow.response.content)
        print(flow.response.json())


# mitmdump  -s  v1.py
# mitmdump  -s  v1.py -q  # 不输出日志

</code></pre>
<h3 id="752">7.5.2 设置代理</h3>
<pre><code class="language-python">from mitmproxy import http
from mitmproxy.net.server_spec import ServerSpec
import requests


def request(flow: http.HTTPFlow):

        res = requests.get('http://192.168.1.12:5010/get/?type=http').json()

        ip, port = res.get('proxy').split(':')
        address = (ip, port)
        print(address)

        flow.server_conn.via = ServerSpec((&quot;http&quot;, address))


def response(flow: http.HTTPFlow):

    print(flow.response.content)


# mitmdump  -s  v1.py -q
# mitmdump -p 8080 -s v1.py --set block_global=false  --set upstream_cert=false --set connection_strategy=lazy -q

</code></pre>


</section>
</div> <!-- end of search-noresults -->
<div class="search-results">
<div class="has-results">

<h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
<ul class="search-results-list"></ul>

</div> <!-- end of has-results -->
<div class="no-results">

<h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>

</div> <!-- end of no-results -->
</div> <!-- end of search-results -->
</div> <!-- end of book-search-results -->

</div> <!-- end of page-inner -->
</div> <!-- end of page-wrapper -->

</div> <!-- end of body-inner -->

</div> <!-- end of book-body -->
<script src="./js/main.js"></script>
<script src="search/main.js"></script>
<script src="./js/gitbook.min.js"></script>
<script src="./js/theme.min.js"></script>
</body>
</html>