<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<title>十五、识货app - App逆向在线笔记</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="generator" content="mkdocs-1.6.1, mkdocs-gitbook-1.0.7">

<link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">
<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta rel="next" href="" />
<link href="./css/style.min.css" rel="stylesheet"> 
</head>

<body>
<div class="book">
<div class="book-summary">
<div id="book-search-input" role="search">
<input type="text" placeholder="Type to search" />
</div> <!-- end of book-search-input -->

<nav role="navigation">
<ul class="summary">
<li>
<a href="index.html" target="_blank" class="custom-link">App逆向在线笔记</a>
</li>
<li class="divider"></li>
<li class="chapter" data-path="index.html">
<a href="index.html">Welcome to Lucky App逆向</a>
<li class="chapter" data-path="day01-%E5%BC%80%E7%8F%AD.html">
<a href="day01-%E5%BC%80%E7%8F%AD.html">一、前期准备</a>
<li class="chapter" data-path="day02-adb.html">
<a href="day02-adb.html">二、adb</a>
<li class="chapter" data-path="day03-%E6%8A%93%E5%8C%85%E5%92%8C%E5%8F%8D%E7%BC%96%E8%AF%91.html">
<a href="day03-%E6%8A%93%E5%8C%85%E5%92%8C%E5%8F%8D%E7%BC%96%E8%AF%91.html">三、抓包和反编译</a>
<li class="chapter" data-path="day04-hook-%E5%B8%B8%E7%94%A8%E5%8A%A0%E5%AF%86-%E6%8A%93%E5%8C%85app.html">
<a href="day04-hook-%E5%B8%B8%E7%94%A8%E5%8A%A0%E5%AF%86-%E6%8A%93%E5%8C%85app.html">四、hook-常用加密-抓包app</a>
<li class="chapter" data-path="day05-%E9%80%86x%E6%A1%88%E4%BE%8B.html">
<a href="day05-%E9%80%86x%E6%A1%88%E4%BE%8B.html">五、抓包和逆向案例</a>
<li class="chapter" data-path="day06-java%E5%9F%BA%E7%A1%8001.html">
<a href="day06-java%E5%9F%BA%E7%A1%8001.html">六、java基础-01</a>
<li class="chapter" data-path="day07-java%E5%9F%BA%E7%A1%8002.html">
<a href="day07-java%E5%9F%BA%E7%A1%8002.html">七、java基础02</a>
<li class="chapter" data-path="day08-java%E5%9F%BA%E7%A1%8003.html">
<a href="day08-java%E5%9F%BA%E7%A1%8003.html">八、java基础03</a>
<li class="chapter" data-path="day09-%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%9101.html">
<a href="day09-%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%9101.html">Day09 安卓开发01</a>
<li class="chapter" data-path="day10-%E5%AE%89%E5%8D%93%E5%9F%BA%E7%A1%8002.html">
<a href="day10-%E5%AE%89%E5%8D%93%E5%9F%BA%E7%A1%8002.html">十、安卓开发02</a>
<li class="chapter" data-path="day10%E5%AE%89%E5%8D%93%E5%9F%BA%E7%A1%80%E5%8A%A0%E5%AF%86%E6%8B%A6%E6%88%AA%E5%99%A8.html">
<a href="day10%E5%AE%89%E5%8D%93%E5%9F%BA%E7%A1%80%E5%8A%A0%E5%AF%86%E6%8B%A6%E6%88%AA%E5%99%A8.html">十、安卓基础加密拦截器</a>
<li class="chapter" data-path="day11-C%E8%AF%AD%E8%A8%80%E5%AE%89%E8%A3%85.html">
<a href="day11-C%E8%AF%AD%E8%A8%80%E5%AE%89%E8%A3%85.html">十一、C语言安装与入门</a>
<li class="chapter" data-path="day12-C%E8%AF%AD%E8%A8%80%E5%92%8CJNI%E5%BC%80%E5%8F%91.html">
<a href="day12-C%E8%AF%AD%E8%A8%80%E5%92%8CJNI%E5%BC%80%E5%8F%91.html">十二、C语言和JNI开发</a>
<li class="chapter" data-path="day13-JNI%E5%BC%80%E5%8F%91.html">
<a href="day13-JNI%E5%BC%80%E5%8F%91.html">十三、JNI开发</a>
<li class="chapter" data-path="day14-%E8%BD%A6%E6%99%BA%E8%B5%A2.html">
<a href="day14-%E8%BD%A6%E6%99%BA%E8%B5%A2.html">十四、车智赢</a>
<li class="chapter active" data-path="day15-%E8%AF%86%E8%B4%A7app.html">
<a href="day15-%E8%AF%86%E8%B4%A7app.html">十五、识货app</a>
<li class="chapter" data-path="day16-%E5%BE%97%E7%89%A9app.html">
<a href="day16-%E5%BE%97%E7%89%A9app.html">十六、得物app</a>
<li class="chapter" data-path="day17-B%E7%AB%99%E6%92%AD%E6%94%BE%E9%87%8Fday01.html">
<a href="day17-B%E7%AB%99%E6%92%AD%E6%94%BE%E9%87%8Fday01.html">十七、B站播放量day01</a>
<li class="chapter" data-path="day18-B%E7%AB%9902.html">
<a href="day18-B%E7%AB%9902.html">十八、B站02</a>
<li class="chapter" data-path="day19-B%E7%AB%9903.html">
<a href="day19-B%E7%AB%9903.html">十九、B站02</a>
<li class="chapter" data-path="day20-%E5%94%AF%E5%93%81%E4%BC%9A01.html">
<a href="day20-%E5%94%AF%E5%93%81%E4%BC%9A01.html">二十、唯品会01</a>
<li class="chapter" data-path="day21-%E5%94%AF%E5%93%81%E4%BC%9A02.html">
<a href="day21-%E5%94%AF%E5%93%81%E4%BC%9A02.html">二十一、唯品会02</a>
<li class="chapter" data-path="day22-DYM.html">
<a href="day22-DYM.html">二十二、DYM</a>
<li class="chapter" data-path="day23-%E9%85%92%E4%BB%99%E7%BD%91.html">
<a href="day23-%E9%85%92%E4%BB%99%E7%BD%91.html">二十三、酒仙网</a>
<li class="chapter" data-path="day24-%E5%8F%B8%E5%B0%8F%E5%AE%9D.html">
<a href="day24-%E5%8F%B8%E5%B0%8F%E5%AE%9D.html">二十四、司小宝</a>
<li class="chapter" data-path="day25-unidbg-%E4%B8%8A.html">
<a href="day25-unidbg-%E4%B8%8A.html">二十五、unidbg-上</a>
<li class="chapter" data-path="day26-unidbg-%E4%B8%AD%E7%AF%87.html">
<a href="day26-unidbg-%E4%B8%AD%E7%AF%87.html">二十六、unidbg-中</a>
<li class="chapter" data-path="day27-unidbg-%E4%B8%8B.html">
<a href="day27-unidbg-%E4%B8%8B.html">二十七、unidbg-下</a>
<li class="chapter" data-path="day28-xhs-%E4%B8%8A.html">
<a href="day28-xhs-%E4%B8%8A.html">二十八、xhs-上</a>
<li class="chapter" data-path="day29-xhs-%E4%B8%8B.html">
<a href="day29-xhs-%E4%B8%8B.html">二十九、xhs-下</a>
<li class="chapter" data-path="day30-%E6%97%A0%E9%9A%9C%E7%A2%8D.html">
<a href="day30-%E6%97%A0%E9%9A%9C%E7%A2%8D.html">三十、无障碍开发</a>
<li class="chapter" data-path="day31-%E6%97%A0%E9%9A%9C%E7%A2%8D.html">
<a href="day31-%E6%97%A0%E9%9A%9C%E7%A2%8D.html">三十一、无障碍image-20240703160302051</a>
<li class="chapter" data-path="day32-%E6%97%A0%E9%9A%9C%E7%A2%8D%E9%83%A8%E7%BD%B2.html">
<a href="day32-%E6%97%A0%E9%9A%9C%E7%A2%8D%E9%83%A8%E7%BD%B2.html">三十二、无障碍项目部署</a>
<li class="divider"></li>



<li><a href="http://www.mkdocs.org">
Published with MkDocs
</a></li>

<li><a href="https://github.com/GitbookIO/theme-default">
Theme by GitBook
</a></li>
</ul>

</nav>

</div> <!-- end of book-summary -->

<div class="book-body">
<div class="body-inner">
<div class="book-header" role="navigation">

<!-- Title -->
<h1>
<i class="fa fa-circle-o-notch fa-spin"></i>
<a href="." ></a>
</h1>

</div> <!-- end of book-header -->

<div class="page-wrapper" tabindex="-1" role="main">
<div class="page-inner">
<div id="book-search-results">
<div class="search-noresults">

<section class="normal markdown-section">



<h1 id="app">十五、识货app</h1>
<h1 id="_1">一、逆向目标</h1>
<pre><code class="language-python"># 1 搜索框搜索商品
# 2 点击进入商品详情
</code></pre>
<p><img alt="image-20230727172656005" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20230727172656005.png" /></p>
<p><img alt="image-20230727172711709" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20230727172711709.png" /></p>
<h1 id="_2">二、版本选择</h1>
<pre><code class="language-python"># 我们使用最新版抓包：识货-7.73.0
# 使用v7.20.1讲绕过强制更新

</code></pre>
<p><img alt="image-20230727172853016" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20230727172853016.png" /></p>
<p><img alt="image-20230727173043858" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20230727173043858.png" /></p>
<h1 id="app_1">三、绕过app强制更新</h1>
<pre><code class="language-python"># 以后使用app，更新会遇到两种情况
    1 选择更新：只是弹出更新框，但是有 关闭，可以关闭，暂时不更新----》app中的所有接口肯定是能用的
    2 强制更新：弹出更新框，直接覆盖住app，无法关闭，必须更新---》可以绕过更新，看看接口是否还能用---》接口能用，接口不能用---》老版本的app，接口解密方式会比最新的简单一些---》识货，就是这种情况



# 绕过强制更新
    1 车智赢：断网，进入app，再打开网络
        -app一启动---》向后端发送请求，获取最新版本版本号，跟本地app版本号做比较，如果相差太大，它就会让你更新app，一般情况下，代码就在app开启的第一个页面上，只要切换到别的页面了，这个代码也就不执行了，于是就绕过了
    2 识货app：断网，绕不过，只要连上网，又需要更新，通过hook，让它不 弹出这个弹出框
        -反编译找到 弹出框的源代码---》通过hook，让这个框不弹出



# 注意点：一定要运行一次app，第一次运行app，一定会弹出一个框，再执行hook
</code></pre>
<h3 id="31-hookspawn">3.1 使用hook方式，让弹窗不执行(spawn方式)</h3>
<ul>
<li>思路</li>
</ul>
<p>搜索    最新版本 </p>
<ul>
<li>
<p>使用spawn方式hook</p>
</li>
<li>
<p>图例</p>
</li>
</ul>
<p><img alt="image-20230727173533340" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20230727173533340.png" /></p>
<ul>
<li>枚举手机上的所有进程 &amp; 前台进程,找到 识货的包名</li>
</ul>
<p>```python
  import frida</p>
<p># 获取设备信息
  rdev = frida.get_remote_device()</p>
<p># 枚举所有的进程
  processes = rdev.enumerate_processes()
  for process in processes:
      print(process)</p>
<p># 获取在前台运行的APP
  front_app = rdev.get_frontmost_application()
  print(front_app)
  # Application(identifier="com.hupu.shihuo", name="识货", pid=28602, parameters={})
  ```</p>
<ul>
<li>端口转发</li>
</ul>
<p>```python
  import subprocess
  # 使用sbuprocess模块，执行命令，如果转发不了，就执行命令</p>
<p>'''
  adb forward tcp:27042 tcp:27042
  adb forward tcp:27043 tcp:27043
  '''
  subprocess.run('adb forward tcp:27042 tcp:27042')
  subprocess.run('adb forward tcp:27043 tcp:27043')
  ```</p>
<ul>
<li>hook代码</li>
</ul>
<p>```python
  import frida
  import sys</p>
<p>rdev = frida.get_remote_device()
  pid = rdev.spawn(["com.hupu.shihuo"])
  session = rdev.attach(pid)</p>
<p>scr = """
  Java.perform(function () {
      var UpdateDialog = Java.use('com.azhon.appupdate.dialog.UpdateDialog');
      UpdateDialog.show.implementation = function(ctx){
          console.log("执行了");
          //this.show();
      }
  });
  """
  script = session.create_script(scr)</p>
<p>def on_message(message, data):
      print(message, data)</p>
<p>script.on("message", on_message)
  script.load()
  rdev.resume(pid)
  sys.stdin.read()
  ```</p>
<ul>
<li>
<p>使用spawn的原因是  当程序启动就要进行hook，防止弹框</p>
</li>
<li>
<p>一运行hook脚本，app闪退了</p>
<p>app做了frida检测
    + 删某些so文件（今天学这种）
    + ptrace占坑
  + frida加强版</p>
</li>
</ul>
<h1 id="frida">四、绕过frida反调试</h1>
<h3 id="1-frida-hook">(1) <strong>不能frida   hook的原因</strong></h3>
<p>识货这款app，做了frida的反调试，检测到只要frida脚本在运行，app就自动结束</p>
<h3 id="2">(2) 对于强制更新的处理方式</h3>
<h4 id="_3"><strong>方法一</strong></h4>
<p>这种公司，一般情况下，公司的安全人员写了一个so文件，检测是否在运行frida的hook，如果检测到，就把app强制终止</p>
<p>安全人员写的so，一般情况下跟app业务无关，只用来做hook的检测，这种情况下，我们可以尝试删除这个so文件尝试一下，如果删除了，app还能顺利运行，说明这个so跟业务是无关的，就可以删除
像识货，得物这种app就是这样的、于是，我们要找到 是那个so文件，做了检测</p>
<p>有的app，会检测frida调试，只要发现，就会不让app启动</p>
<ul>
<li>处理</li>
</ul>
<p>一般这种公司的安全人员会单独写so文件用来检测，所以我们可以hook-app启动时，执行了那些so文件，发现执行到最后一个程序闪退了，一般就是因为这个so文件导致的，我们可以尝试删除试试</p>
<ul>
<li>HOOK 安卓系统底层的函数：dlopen和android_dlopen_ext</li>
</ul>
<p><code>/data/app/~~GdbbeiF3cSp7reYK3i9dNg==/com.hupu.shihuo-wgqwYzKqYcSDqMWwvyzXEQ==/lib/arm64/libmsaoaidsec.so</code></p>
<p>发现最后执行libmsaoaidsec.so报错了这样可以把这个so文件删除</p>
<ul>
<li>步骤</li>
</ul>
<p><code>adb shell
  su
  cd /data/app/~~GdbbeiF3cSp7reYK3i9dNg==/com.hupu.shihuo-wgqwYzKqYcSDqMWwvyzXEQ==/lib/arm64/
  rm libmsaoaidsec.so</code></p>
<h4 id="_4"><strong>方法二</strong></h4>
<p>断网执行app，发现能正常打开app后，在打开网络，刷新也可以</p>
<h3 id="3-hook-appso">(3) hook app在启动过程中执行了那些so文件</h3>
<ul>
<li>代码</li>
</ul>
<p>```python
  import frida
  import sys</p>
<p>rdev = frida.get_remote_device()
  pid = rdev.spawn(["com.hupu.shihuo"])
  session = rdev.attach(pid)</p>
<p>scr = """
  Java.perform(function () {</p>
<pre><code>  var dlopen = Module.findExportByName(null, "dlopen");   // 老版本的App
  var android_dlopen_ext = Module.findExportByName(null, "android_dlopen_ext");  // 新版本的App

  Interceptor.attach(dlopen, {
      onEnter: function (args) {
          var path_ptr = args[0];
          var path = ptr(path_ptr).readCString();
          console.log("[dlopen:]", path);
      },
      onLeave: function (retval) {

      }
  });

  Interceptor.attach(android_dlopen_ext, {
      onEnter: function (args) {
          var path_ptr = args[0];
          var path = ptr(path_ptr).readCString();
          console.log("[dlopen_ext:]", path);
      },
      onLeave: function (retval) {

      }
  });
</code></pre>
<p>});
  """
  script = session.create_script(scr)</p>
<p>def on_message(message, data):
      print(message, data)</p>
<p>script.on("message", on_message)
  script.load()
  rdev.resume(pid)
  sys.stdin.read()
  ```</p>
<ul>
<li>图例</li>
</ul>
<p><img alt="image-20230727175234861" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20230727175234861.png" /></p>
<h1 id="_5">五、抓包分析</h1>
<pre><code class="language-python"># 使用charles抓包，发现只能抓到一些静态文件的包
# 安卓开发时，OkHttp发送请求，设置 `Proxy.NO_PROXY`，基于系统代理都是抓不到包
# 使用一款app，转发更底层的包，实现抓包：有很多，推荐使用： SocksDroid（推荐）
</code></pre>
<p><img alt="image-20230727175953537" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20230727175953537.png" /></p>
<pre><code class="language-java">OkHttpClient client = new OkHttpClient();
FormBody form = new FormBody.Builder()
    .add(&quot;user&quot;, dataMap.get(&quot;username&quot;))
    .add(&quot;pwd&quot;, dataMap.get(&quot;password&quot;))
    .add(&quot;sign&quot;, dataMap.get(&quot;sign&quot;)).build();

Request req = new Request.Builder().url(&quot;http://192.168.0.6:9999/login&quot;).post(form).build();
Call call = client.newCall(req);
...
</code></pre>
<p>修改为:</p>
<pre><code class="language-java">OkHttpClient client = new OkHttpClient.Builder().proxy(Proxy.NO_PROXY).build();
FormBody form = new FormBody.Builder()
    .add(&quot;user&quot;, dataMap.get(&quot;username&quot;))
    .add(&quot;pwd&quot;, dataMap.get(&quot;password&quot;))
    .add(&quot;sign&quot;, dataMap.get(&quot;sign&quot;)).build();

Request req = new Request.Builder().url(&quot;http://192.168.0.6:9999/login&quot;).post(form).build();
</code></pre>
<p>这种情况如何抓包呢？</p>
<h2 id="51-app">5.1 绕过app检测使用代理</h2>
<p><img alt="image-20230727180425940" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20230727180425940.png" /></p>
<p><img alt="image-20230727180508402" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20230727180508402.png" /></p>
<p><img alt="image-20230727180611805" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20230727180611805.png" /></p>
<h3 id="511-socksdroid">5.1.1  SocksDroid（推荐）</h3>
<ul>
<li>手机系统代理删除</li>
<li>基本配置</li>
</ul>
<p>切记：在使用前<strong>删除</strong>手机上设置的系统代理。</p>
<p><img alt="image-20230727180643212" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20230727180643212.png" /></p>
<p><img alt="image-20220928184546944" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20220928184546944.png" /></p>
<p><img alt="image-20230727180857286" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20230727180857286.png" /></p>
<p><img alt="image-20230727180958136" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20230727180958136.png" /></p>
<h3 id="512-drony">5.1.2 drony</h3>
<p>安装在手机、模拟器上的一个软件，对你的手机中某些app中的请求进行转发。</p>
<ul>
<li>Drony-102.apk           【英文版】   【安卓低版本】【模拟器】</li>
<li>Drony-1-3.154.apk    【繁体中文】【手机】</li>
</ul>
<p>打开app，滑动进入settings配置页面。</p>
<p>注意：这个app不稳定，有时加载不出 WIFI，所以就没办法使用了。</p>
<p><img alt="image-20220928183642556" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20220928183642556.png" /></p>
<p><img alt="image-20220928183722670" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20220928183722670.png" /></p>
<h3 id="513-proxydroid">5.1.3 ProxyDroid</h3>
<p>切记：在使用前<strong>删除</strong>手机上设置的系统代理。</p>
<p><img alt="image-20220928185501772" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20220928185501772.png" /></p>
<p><img alt="image-20220928185636086" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20220928185636086.png" /></p>
<h2 id="52">5.2 抓包</h2>
<pre><code class="language-python"># 在搜索栏中，输入   马丁靴  点击搜索，抓包查看

# 尝试改包，发现请求头好多都可以不携带

# 请求参数一部分也可以不携带
</code></pre>
<p><img alt="image-20230727181614083" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20230727181614083.png" /></p>
<h2 id="53-python">5.3 直接通过python重写搜索商品接口</h2>
<h3 id="532-1">5.3.2 接口1</h3>
<pre><code class="language-python">
# 老接口，  搜索台球杆
import requests

res = requests.post(
    url='https://sh-api.shihuo.cn/daga/search/goods/v1',
    params={
        'minVersion': '15670',
        'clientCode': '{holder}',
        'v': '7.20.1',
        'channel': 'myapp',
        'device': 'Pixel 2 XL',
        'platform': 'android',
        'timestamp': '1703770453838'
    },
    json={
        &quot;keywords&quot;: &quot;篮球&quot;,  # 搜其他商品，只要改这个名字即可
        &quot;page&quot;: &quot;1&quot;,
        &quot;pageSize&quot;: &quot;20&quot;,
    },
    verify=False
)

print(res.text)
</code></pre>
<h3 id="531-2">5.3.1 接口2</h3>
<pre><code class="language-python">import requests
from utils import header_str_to_dict
head_str='''
refer   shihuo%3A%2F%2Fwww.shihuo.cn%3Froute%3DhomeSearchList%26keywords%3D%25E8%25B7%2591%25E9%259E%258B%26user_input%3D%2525E8%2525B7%252591%2525E9%25259E%25258B%26lspm%3D874c39aa57fa1dc7%26auto_spm%3D1%23%257B%2522from%2522%253A%2522shihuo%253A%255C%252F%255C%252Fwww.shihuo.cn%253Froute%253Dhome%2522%252C%2522block%2522%253A%2522search_find%2522%252C%2522extra%2522%253A%2522%2525E8%2525B7%252591%2525E9%25259E%25258B%2522%252C%2522lspm%2522%253A%2522874c39aa57fa1dc7%2522%257D
pid homeSearchList_8865534F6DEC9A9005C691150AB3C762
platform    android
timestamp   1715156762196
app-v   7.20.1
sh-token    TWZb7XybBfM2RkMjgzMmQ5OWE4NDdmNDk02uaDcxmACoVeNwQ6LYIoiHOaw/B8RCSaIn5bmnUyFR2xN3IpoSr5ac9dO+OdUrmdcXhSLs9pqFLWR+/y0u9BB3AOy/kJuHhXmyq6J5x/YQhnDk2BFo55k0NRJ2d6ad4MGdPKbxXf3SOZNn/Nss1Cng==
sh-id   25v48ze69aff513bc9558c019c697605
sh-sign F6D9FB867DE1F7542200743BF8B1BA2A
abtest-control  aB=1;Oq=12;Wy=2;HN=3;Ov=1;Gs=0;zF=1;aQ=0;Xj=1;qe=1;QF=11;rK=2;zT=0;IG=0;AA=1;af=12;jO=2;am=0;Ht=23;ZG=2;shrec_is_gdetail=11;rd=1;Qd=1;kB=11;ay=3;jc=5;sM=0;search_wf=2;JG=1;ZW=11;zz=12;Qv=11;Ah=13;bn=0;sa=0;JZ=0;sf=12;Av=23;Rg=3;cY=1;Rh=15;tK=3;Zr=1;dD=1;SV=12;KO=0;tY=1;dK=2;t_s=1715155606176;gdetail_brand_rec=11;KY=1;By=1;ld=0;uO=0;LI=0;data_community_relate=12;dc=1;ln=2;Su=32;eI=3;tx=19;LR=2;Sz=14;eO=0;DO=HN_3;Ta=1;uc=2;Df=12;Lp=12;data_community_personal=89;fK=12;UZ=1;fL=0;Lu=1;nY=2;EQ=2;ev=2;vn=12;wQ=2;mainSearchV3=25;fa=0;NI=1;mainSearchV4=23;nj=2;nn=0;shrec_gdetail_bags=13;data_gdetail_shoes_personal=11;data_gdetail_clothes_personal=12;shoes_ratio_ctrl=1;oZ=12;fr=2;gdetail_shoes_brand_rec=11;gX=0;fx=2;Vi=22;xL=2;shrec_home_feed=17;ws=0;Fd=2;xV=0;gf=13;gh=0;ou=3;GP=0;shrec_cf_mine_v2=11;XD=0;hW=3;Wg=12;pa=0;shrec_gdetail_clothes=13;XK=12;Od=13;PE=12;yN=1;PN=2
shreqid 87680E97CD63EDFDDBFE6C452F5CED4F
osv 11
network 1
sh_session  01934cfa8a7b4ce7a86f0611459fcb4a_foreground_407172
sk  9MRYHxYzeIwT5VTCyBnbXFdf39hbCo06r1oTpaW4rnNvheJuLIckKkSUH2cpirlmXot9rIFBAvDP37nmOXBb7L5Drd1x
appid   app
cookie  acw_tc=2f624a4c17151552501193758e4da50ba495ea298d40dd3c222f28b04ab94c
user-agent  Android 11 {Z29vZ2xl} CPU_ABI arm64-v8a CPU_ABI2  HARDWARE taimen MODEL {UGl4ZWwgMiBYTA} network/WIFI shihuo/7.20.1 sc({holder},myapp) minVersion(15670) sh-dv-sign[v1|10418e17bc015815ef161fc2a5029c0d0d2751f79b8da0aa]
daga-ban-personal   0
content-type    application/json; charset=UTF-8
content-length  575
accept-encoding gzip
'''
header=header_str_to_dict(head_str)

res = requests.post(
    url=&quot;https://sh-gateway.shihuo.cn/v3/sh-api/daga/search/goods/v1&quot;,
    params={
        'minVersion': 19612,
        'clientCode': '%7Bholder%7D',
        'v': '7.53.0',
        'channel': 'ali',
        'device': 'Pixel%202%20XL',
        'platform': 'android',
        'timestamp': '1690444861584',
        'token': '834ea7eb83f036235fe8d19a3b9b4b05'
    },
    headers=header,
    json={
        &quot;keywords&quot;: &quot;马丁靴&quot;,
        &quot;pageSize&quot;: &quot;10&quot;,
        &quot;page&quot;: &quot;1&quot;,

    }, verify=False
)
print(res.text)
data_dict = res.json()

for item in data_dict['data']['lists']:
    print(item['name'])
    for ele in item['style_lists']:
        print('-----', ele['goods_id'], ele['name'], ele['price'])

</code></pre>
<h2 id="54">5.4 商品详情接口</h2>
<pre><code class="language-python"># 抓包发现商品详情接口返回数据加密了
# preload
</code></pre>
<p><img alt="image-20230727184224207" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20230727184224207.png" /></p>
<h1 id="hook">六、Hook各种尝试</h1>
<h2 id="61-hook-map-">6.1 hook- Map - 失败</h2>
<pre><code class="language-python"># 1 通过hook map操作，确认是不是走了这
    data:加密数据--》很有可能在app内部--》map.put('data',xx.sign(数据))
    我们可以尝试hook--map---》确认是不是这种思路
    咱们这个app不是
</code></pre>
<pre><code class="language-python">import frida
import sys

rdev = frida.get_remote_device()
session = rdev.attach(&quot;识货&quot;)

scr = &quot;&quot;&quot;
Java.perform(function () {
    var TreeMap = Java.use('java.util.TreeMap');
    var Map = Java.use(&quot;java.util.Map&quot;);

    TreeMap.put.implementation = function (key,value) {
        if(key==&quot;data&quot;){
            console.log(key,value);
        }
        var res = this.put(key,value);
        return res;
    }
});
&quot;&quot;&quot;
script = session.create_script(scr)


def on_message(message, data):
    print(message, data)


script.on(&quot;message&quot;, on_message)
script.load()
sys.stdin.read()
</code></pre>
<h2 id="62-hook-stringbuilder-">6.2 Hook StringBuilder-失败</h2>
<pre><code class="language-python"># 2 没走map ，有可能走了 字符串拼接
StringBuilder sb =new StringBuilder();
sb.append('data')
sb.append('加密字符串')
sb.toString()
# 把它转成真正的字符串
# 通过hook StringBuilder 的toString 方法看看有没有走
</code></pre>
<pre><code class="language-python">import frida
import sys

rdev = frida.get_remote_device()
session = rdev.attach(&quot;识货&quot;)

scr = &quot;&quot;&quot;
Java.perform(function () {
    var StringBuilder = Java.use(&quot;java.lang.StringBuilder&quot;);

    StringBuilder.toString.implementation = function () {
        var res = this.toString();
        console.log(res); 
        return res;
    }

});
&quot;&quot;&quot;
script = session.create_script(scr)


def on_message(message, data):
    print(message, data)


script.on(&quot;message&quot;, on_message)
script.load()
sys.stdin.read()

</code></pre>
<h3 id="62-jshook">6.2 使用js的hook</h3>
<pre><code class="language-js">// hook_stringbuilder.js

Java.perform(function () {
    var StringBuilder = Java.use(&quot;java.lang.StringBuilder&quot;);

    StringBuilder.toString.implementation = function () {
        var res = this.toString();
        console.log(res);
        return res;
    }
});

// frida -UF  hook_stringbuilder.js -o string.txt

// 发现并没有输出到string.txt中
</code></pre>
<h2 id="63-hook-base64-">6.3 Hook-base64-成功</h2>
<pre><code class="language-python">import frida
import sys

rdev = frida.get_remote_device()
session = rdev.attach(&quot;识货&quot;)

scr = &quot;&quot;&quot;
Java.perform(function () {
    var Base64 = Java.use(&quot;android.util.Base64&quot;);

    Base64.encodeToString.overload('[B', 'int').implementation = function (bArr,val) {
        var res = this.encodeToString(bArr,val);
        console.log(&quot;加密了--&gt;&quot;,res);
        return res;
    }
});
&quot;&quot;&quot;
script = session.create_script(scr)


def on_message(message, data):
    print(message, data)


script.on(&quot;message&quot;, on_message)
script.load()
sys.stdin.read()

# 通过查看输出，那请求的数据搜索，发现hook到了

</code></pre>
<h2 id="64-hook">6.4 hook 拦截器</h2>
<pre><code class="language-python"># 请求加密，返回的数据解密，很有可以能是在拦截器中完成处理


</code></pre>
<h3 id="641-jshookhook">6.4.1 js的hook拦截器,hook所有</h3>
<pre><code class="language-js">// hook_Interceptor.js
Java.perform(function () {
    var Builder = Java.use('okhttp3.OkHttpClient$Builder');

    Builder.addInterceptor.implementation = function (inter) {

        console.log(JSON.stringify(inter) );
        return this.addInterceptor(inter);
    };
})

//frida -Uf com.hupu.shihuo -l hook_Interceptor.js -o all_interceptor3.txt
</code></pre>
<pre><code class="language-txt">&quot;&lt;instance: okhttp3.Interceptor, $className: com.shizhi.shihuoapp.library.net.h.h&gt;&quot;
&quot;&lt;instance: okhttp3.Interceptor, $className: com.shizhi.shihuoapp.library.imageview.loader.c.b$a&gt;&quot;
&quot;&lt;instance: okhttp3.Interceptor, $className: com.shizhi.shihuoapp.library.net.h.e&gt;&quot;
&quot;&lt;instance: okhttp3.Interceptor, $className: com.shizhi.shihuoapp.library.net.h.d&gt;&quot;
&quot;&lt;instance: okhttp3.Interceptor, $className: com.shizhi.shihuoapp.library.net.h.b&gt;&quot;
&quot;&lt;instance: okhttp3.Interceptor, $className: com.shizhi.shihuoapp.library.net.h.h&gt;&quot;
&quot;&lt;instance: okhttp3.Interceptor, $className: com.shizhi.shihuoapp.library.net.h.g&gt;&quot;
&quot;&lt;instance: okhttp3.Interceptor, $className: com.shizhi.shihuoapp.library.net.h.a&gt;&quot;
&quot;&lt;instance: okhttp3.Interceptor, $className: cn.shihuo.modulelib.utils.f1.a$a&gt;&quot;
&quot;&lt;instance: okhttp3.Interceptor, $className: cn.shihuo.modulelib.startup.core.c.b&gt;&quot;
&quot;&lt;instance: okhttp3.Interceptor, $className: cn.shihuo.modulelib.startup.core.c.a&gt;&quot;
&quot;&lt;instance: okhttp3.Interceptor, $className: com.shizhi.shihuoapp.library.net.h.d&gt;&quot;
&quot;&lt;instance: okhttp3.Interceptor, $className: com.shizhi.shihuoapp.library.net.h.h&gt;&quot;
&quot;&lt;instance: okhttp3.Interceptor, $className: com.shizhi.shihuoapp.library.net.h.g&gt;&quot;
&quot;&lt;instance: okhttp3.Interceptor, $className: cn.shihuo.modulelib.utils.f1.a$a&gt;&quot;
&quot;&lt;instance: okhttp3.Interceptor, $className: cn.shihuo.modulelib.startup.core.c.b&gt;&quot;
&quot;&lt;instance: okhttp3.Interceptor, $className: cn.shihuo.modulelib.startup.core.c.a&gt;&quot;
</code></pre>
<h3 id="642-">6.4.2 一个个尝试拦截器--查找</h3>
<pre><code class="language-python">import frida
import sys

rdev = frida.get_remote_device()
session = rdev.attach(&quot;识货&quot;)

scr = &quot;&quot;&quot;
Java.perform(function () {
    var a = Java.use(&quot;cn.shihuo.modulelib.startup.core.c.a&quot;);

    a.intercept.implementation = function (chain) {
        var req = chain.request();
        var httpUrl = req.url().toString();
        if( httpUrl.indexOf(&quot;https://sh-gateway.shihuo.cn/v4/services/sh-goodsapi/app_swoole_shoe/preload/single&quot;) != -1 ){
            console.log('执行前',httpUrl);    
        }

        var res = this.intercept(chain); // 执行自己这个拦截器
        return res;
    }

});
&quot;&quot;&quot;
script = session.create_script(scr)


def on_message(message, data):
    print(message, data)


script.on(&quot;message&quot;, on_message)
script.load()
sys.stdin.read()
</code></pre>
<pre><code class="language-python">import frida
import sys

rdev = frida.get_remote_device()
session = rdev.attach(&quot;识货&quot;)

scr = &quot;&quot;&quot;
Java.perform(function () {
    var a = Java.use(&quot;cn.shihuo.modulelib.utils.f1.a$a&quot;);

    a.intercept.implementation = function (chain) {
        var req = chain.request();
        var httpUrl = req.url().toString();
        if( httpUrl.indexOf(&quot;https://sh-gateway.shihuo.cn/v4/services/sh-goodsapi/app_swoole_shoe/preload/single&quot;) != -1 ){
            console.log('执行前',httpUrl);    
        }
        // 不走自己的拦截器了，跳过该拦截器执行，继续执行下面的拦截器
        var response = chain.proceed(req);
        return response;
    }

});
&quot;&quot;&quot;
script = session.create_script(scr)


def on_message(message, data):
    print(message, data)


script.on(&quot;message&quot;, on_message)
script.load()
sys.stdin.read()


// 这个拦截器找到了可以发送明文的地址
</code></pre>
<p><img alt="image-20230727193250609" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20230727193250609.png" /></p>
<p><img alt="image-20231011192658293" src="imgs/day15-%E8%AF%86%E8%B4%A7app.assets/image-20231011192658293.png" /></p>
<h1 id="7python">7、python直接发送请求获取详情</h1>
<pre><code class="language-python">import requests

headers = {
    'sk': '9MRYHxYzeIwT5VTCyBnbXFdf39hbCo06r1oTpaW4rnNvheJuLIckKkSUH2cpirlmXot9rIFBAvDP37nmOXBb7L5Drd1x',
    'user-agent': 'Android 11 {Z29vZ2xl} CPU_ABI arm64-v8a CPU_ABI2  HARDWARE taimen MODEL {UGl4ZWwgMiBYTA} network/WIFI shihuo/7.20.1 sc({holder},myapp) minVersion(15670) sh-dv-sign[v1|10418e17bc015815ef161fc2a5029c0d0d2751f79b8da0aa]'

}
res = requests.get(
    'https://sh-gateway.shihuo.cn/v4/services/sh-goodsapi/app_swoole_shoe/preload/single',
    params={
        'goods_id': '379112',
        'v': '7.20.1',
    },
    verify=False, headers=headers)
print(res.json())

</code></pre>
<h1 id="8">8、代码整合</h1>
<h2 id="81-7201">8.1 7.20.1版本</h2>
<pre><code class="language-python">import requests
from utils import header_str_to_dict
import urllib3

urllib3.disable_warnings()
header_str = '''
sh-token    07YHP1RqF2ZjZiZDRlMjg0ZWJlNmY5OWRiVrVJil+FyNFpPfAYRwUnQZjD7Y0EMrH0URCKv764zx2HrJrYl7RugWdY2JZP2mlh2o63ZQhD9f2BlkbdZzS3eRaVNn+LfKaM+2xWa3yAnTwDsBJq658HFt7VNjuaBKnX+e9kjFcgtdCl2h0kIgZyFA=='''
headers = header_str_to_dict(header_str)
# 搜索商品的接口
res = requests.post(
    url=&quot;https://sh-api.shihuo.cn/daga/search/goods/v1?minVersion=15670&amp;clientCode=%7Bholder%7D&amp;v=7.20.1&amp;channel=myapp&amp;device=Pixel%202%20XL&amp;platform=android&amp;timestamp=1697021144536&amp;token=3dec4554119714351dedd1f457099573&quot;,
    # headers=headers,
    json={
        &quot;keywords&quot;: &quot;帆布鞋&quot;,
        &quot;pageSize&quot;: &quot;20&quot;,
        &quot;page&quot;: &quot;1&quot;,

    }, verify=False
)
print(res.text)
data_dict = res.json()

print('------')
l = []
for item in data_dict['data']['lists']:
    try:
        print(item['name'])
        for ele in item['style_lists']:
            print('-----', ele['goods_id'], ele['name'], ele['price'])
            # 通过商品id，获取商品的详情
            l.append(ele['goods_id'])
    except:
        pass

header_str = '''
platform    android
timestamp   1697022069424
app-v   7.20.1
sh-token    19Zo0LudYxM2M3NDBiZThjNmNjNTM1ZGMwnqndf6tomH872jLQjhgYbdFdIyqJGmWsdG6mb1tPj5mcB/3l6G58H274IwjqbjH09QyGMZg/QEqYOjTFSXdZ6SqroQY0+7KrhcoExdS0hlCpdaSb4FF9/sPivU2Eh9ZoPRaufuOMqX08wzYTIF4eug==
sh-id   913962kpcbdb29f68fc2552232c86cb3
sh-sign DF380FBA1CF473B2FDD4BC570F6EB5B1
abtest-control  ln=3;eI=3;HN=0;LR=0;Ks=0;eN=2;Gs=2;zF=1;Ta=2;uc=2;aQ=0;Xj=1;zT=0;IG=0;AA=2;Df=13;MQ=1;fK=11;data_community_personal=3;jO=2;UZ=0;fL=0;Lu=1;nY=2;am=0;EQ=2;shrec_is_gdetail=12;RA=2;ev=22;kA=3;kB=11;ay=3;gA=2;mainSearchV3=25;search_wf=3;NI=0;mainSearchV4=27;nj=2;Us=1;nn=0;zz=12;Yz=1;shrec_gdetail_bags=11;Qv=17;Ah=11;data_gdetail_shoes_personal=11;data_gdetail_clothes_personal=11;oZ=12;shoes_ratio_ctrl=0;bn=0;sa=0;Ap=2;gdetail_shoes_brand_rec=11;JZ=1;SD=0;fx=3;sf=12;Av=24;sh=0;Rg=2;cY=1;Rh=15;tK=3;shrec_home_feed=17;Fd=2;gf=12;dD=0;gh=0;CI=1;ou=3;dK=0;Fn=3;CL=2;GP=1;t_s=1697020869050;oy=2;gdetail_brand_rec=11;shrec_cf_mine_v2=11;KY=6;hW=3;Wg=12;pa=0;shrec_gdetail_clothes=11;Od=11;yN=8;By=0;Bz=0;uO=0;data_community_relate=11;dc=1
shreqid 57F9D010EF0EA0A05E845396BA6B3E1F
osv 11
network 1
sh_session  7804c48b010b40f699adcc4b4aaa89f0_foreground_1002591
sk  9MJTD4FFJBgRUPSgNfZIKOA8bCGnv4wt7McVWcxBYyOZBJiez6r4AjzcgGweapZa1GGcamedBEXYqzEOVegB7d2klJ1w
appid   app
cookie  acw_tc=76b20fe616970207931503924e60da603e28e89a17d213f16b5b87b95b3433
user-agent  Android 11 {Z29vZ2xl} CPU_ABI arm64-v8a CPU_ABI2  HARDWARE taimen MODEL {UGl4ZWwgMiBYTA} network/WIFI shihuo/7.20.1 sc({holder},myapp) minVersion(15670) sh-dv-sign[v1|6bd3e4ffa3ce6c880e6681a9f90775c60d2751f79b8da0aa]
'''
for good_id in l:
    print(good_id)

    headers = header_str_to_dict(header_str)
    res = requests.get(
        url=f'https://sh-gateway.shihuo.cn/v4/services/sh-goodsapi/app_swoole_shoe/preload/single?devices=Pixel%202%20XL&amp;dspm=95e6ec308860e77a&amp;gender=2&amp;goods_id={good_id}&amp;sourceLocation=oneRowOne%3A%5BN%5D&amp;style_id=40941356&amp;top_style_id=40941356&amp;tpExtra=%7B%22sourceTp%22%3A%22home%3Asearch%3A%22%2C%22sourceTpName%22%3A%22%E5%B8%86%E5%B8%83%E9%9E%8B%22%2C%22wsf%22%3A%22normal_search_words%22%2C%22ast%22%3A%22%E5%B8%86%E5%B8%83%E9%9E%8B%22%2C%22is_inspire%22%3A0%2C%22dgReqId%22%3A%22SHSS_CG-O7CKNHGTO8RT_SPU_1%3A27%22%2C%22si%22%3A%228001%22%2C%22skc%22%3A%2240941356%22%2C%22layer%22%3A%222%22%7D&amp;access_token=b7EM8Up9VSFJUhkyEJ&amp;minVersion=15670&amp;clientCode=%7Bholder%7D&amp;v=7.20.1&amp;channel=myapp&amp;device=Pixel%202%20XL&amp;platform=android&amp;timestamp=1697022069424&amp;access_token=b7EM8Up9VSFJUhkyEJ&amp;token=570a49e713cc2b3a2a3a1e627878b86b',
        verify=False,
        headers=headers
    )
    # print(res.text)
    print('付款人数：', res.json()['data']['info']['goods_info']['monthSellPoint'])

</code></pre>
<h2 id="82-7530">8.2 7.53.0版本</h2>
<pre><code class="language-python">import requests
from utils import header_str_to_dict
import urllib3
urllib3.disable_warnings()
header_str = '''
refer   shihuo%3A%2F%2Fwww.shihuo.cn%3Froute%3DhomeSearch%26back_keywords%3D%25E8%2593%259D%25E7%2589%2599%25E8%2580%25B3%25E6%259C%25BA%25E9%2599%258D%25E5%2599%25AA%23%257B%2522block%2522%253A%2522search_input%2522%252C%2522from%2522%253A%2522home%2522%257D
pid homeSearch_08907F10C20205C3B1D19B121A5A5321
platform    android
timestamp   1697020149464
app-v   7.53.0
sh-token    c7Gi24g3lIM2RkMjgzMmQ5OWE4NDdmNDk02uaDcxmACoVeNwQ6LYIoiHOaw/B8RCSaIn5bmnUyFR2xN3IpoSr5ac9dO+OdUrmdcXhSLs9pqFLWR+/y0u9BB6+NNidP8oW4V82ru7HwUeN0LET/q8er8vw8O0d+KQJ9GdPKbxXf3SOZNn/Nss1Cng==
sh-id   913962kpcbdb29f68fc2552232c86cb3
sh-sign 091A77B6E175B7DC766EA23DF87EA9AA
sh-ba   j6Mg22d4xAZGUyYTZhN2IxNDZiZThhMjFh6tTZOBoW8biiQvHJ55PwfE5G5N7SpzkuJ0bPx+8xxiri0EYrhT51muca+Y/Xj5Ui
sh-jt   f8Xf75z6fLZTc4YTU0NDZjMTljMzkxYzYyUE4q1fu2s3paDsEUe7p9rVS2QVOEHdpWrUkUDQGvCbWkwFvs8w3uDzC+9UeYb6jA
Abtest-Control  HN=0;iO=1;zF=1;Gs=2;aQ=0;Xj=1;zT=0;IG=0;AA=2;jO=2;am=0;shrec_is_gdetail=12;RA=2;kA=3;kB=11;ay=3;search_wf=3;zz=12;Yz=1;Qv=17;Ah=11;Qz=1;bn=0;Ao=3;sa=0;Ap=2;JZ=1;SD=0;sf=12;Rg=2;sh=0;Av=24;Rh=15;cY=1;dD=0;sw=5;CI=1;dK=0;CL=2;t_s=1697018757864;Bl=3;gdetail_brand_rec=11;KY=6;By=0;Bz=0;uO=0;data_community_relate=11;dc=1;ln=3;eI=3;LR=0;Ks=0;eN=2;Ta=2;uc=2;ds=1;Df=13;MQ=1;UZ=0;data_community_personal=3;fK=11;fL=0;el=2;Lu=1;MX=2;nY=2;EQ=2;ev=22;gA=2;mainSearchV3=25;NI=0;mainSearchV4=27;nj=2;Us=1;shrec_gdetail_bags=11;NT=2;data_gdetail_shoes_personal=11;data_gdetail_clothes_personal=11;shoes_ratio_ctrl=0;oZ=12;gdetail_shoes_brand_rec=11;fx=3;Nf=1;shrec_home_feed=17;Fd=2;gf=12;gh=0;ot=0;Fn=3;GP=1;oy=2;shrec_cf_mine_v2=11;Wg=12;shrec_gdetail_clothes=11;pa=0;yN=8;Od=11;HA=1
shreqid 832792377A33D4400275C0C663805D7E
osv 11
network 1
sh_session  49fce76f13984868948bed9268ccf637_foreground_11232
SK  9MJTD4FFJBgRUPSgNfZIKOA8bCGnv4wt7McVWcxBYyOZBJiez6r4AjzcgGweapZa1GGcamedBEXYqzEOVegB7d2klJ1w
luid    62dc8445-356e-4edb-a7a1-aafff91592e8
appid   app
User-Agent  Android 11 {Z29vZ2xl} CPU_ABI arm64-v8a CPU_ABI2  HARDWARE taimen MODEL {UGl4ZWwgMiBYTA} network/WIFI shihuo/7.53.0 sc({holder},ali) minVersion(19612) sh-dv-sign[v1|6bd3e4ffa3ce6c880e6681a9f90775c60d2751f79b8da0aa]
daga-ban-personal   0
is-retry    1
Content-Type    application/json; charset=UTF-8
Content-Length  731
Host    sh-gateway.shihuocdn.cn
Connection  Keep-Alive
Accept-Encoding gzip
'''
headers = header_str_to_dict(header_str)
# 搜索商品的接口
res = requests.post(
    url=&quot;https://sh-gateway.shihuocdn.cn/v3/sh-api/daga/search/goods/v1?minVersion=19612&amp;clientCode=%7Bholder%7D&amp;v=7.53.0&amp;channel=ali&amp;device=Pixel%202%20XL&amp;platform=android&amp;timestamp=1697020149464&amp;token=ab8a41ceb34afc8132569d645e667685&quot;,
    headers=headers,
    json={
        &quot;keywords&quot;: &quot;匹克&quot;,
        &quot;pageSize&quot;: &quot;20&quot;,
        &quot;page&quot;: &quot;1&quot;,

    }, verify=False
)
print(res.text)
data_dict = res.json()

print('------')
l = []
for item in data_dict['data']['lists']:
    print(item['name'])
    for ele in item['style_lists']:
        print('-----', ele['goods_id'], ele['name'], ele['price'])
        # 通过商品id，获取商品的详情
        l.append(ele['goods_id'])

header_str = '''
platform    android
timestamp   1715158360958
app-v   7.20.1
sh-token    dVOH0tjz1AZGUyYTZhN2IxNDZiZThhMjFh4FI76fz0PCUWUTjVeS7H4csPX8yqPP6xIS1gSDJXQVoekFZFC2EYEF1WFBmqiGkXOykRfq0w+QwZ6kylJQFIN7RiIW8DzeJxass+KpLNr5TLgWuc+zgNvfAYFjZBsTNug1aymES4kBeuFaRTCWZ2kA==
sh-id   25v48ze69aff513bc9558c019c697605
sh-sign 4DECAAB64F3C4FFE3A2AD6BF2503421B
abtest-control  aB=1;Oq=12;Wy=2;HN=3;Ov=1;Gs=0;zF=1;aQ=0;Xj=1;qe=1;QF=11;rK=2;zT=0;IG=0;AA=1;af=12;jO=2;am=0;Ht=23;ZG=2;shrec_is_gdetail=11;rd=1;Qd=1;kB=11;ay=3;jc=5;sM=0;search_wf=2;JG=1;ZW=11;zz=12;Qv=11;Ah=13;bn=0;sa=0;JZ=0;sf=12;Av=23;Rg=3;cY=1;Rh=15;tK=3;Zr=1;dD=1;SV=12;KO=0;tY=1;dK=2;t_s=1715155606176;gdetail_brand_rec=11;KY=1;By=1;ld=0;uO=0;LI=0;data_community_relate=12;dc=1;ln=2;Su=32;eI=3;tx=19;LR=2;Sz=14;eO=0;DO=HN_3;Ta=1;uc=2;Df=12;Lp=12;data_community_personal=89;fK=12;UZ=1;fL=0;Lu=1;nY=2;EQ=2;ev=2;vn=12;wQ=2;mainSearchV3=25;fa=0;NI=1;mainSearchV4=23;nj=2;nn=0;shrec_gdetail_bags=13;data_gdetail_shoes_personal=11;data_gdetail_clothes_personal=12;shoes_ratio_ctrl=1;oZ=12;fr=2;gdetail_shoes_brand_rec=11;gX=0;fx=2;Vi=22;xL=2;shrec_home_feed=17;ws=0;Fd=2;xV=0;gf=13;gh=0;ou=3;GP=0;shrec_cf_mine_v2=11;XD=0;hW=3;Wg=12;pa=0;shrec_gdetail_clothes=13;XK=12;Od=13;PE=12;yN=1;PN=2
shreqid 21B01EA33C50EC25B0D9AFA9340AA1EA
osv 11
network 1
sh_session  01934cfa8a7b4ce7a86f0611459fcb4a_foreground_2005934
sk  9MRYHxYzeIwT5VTCyBnbXFdf39hbCo06r1oTpaW4rnNvheJuLIckKkSUH2cpirlmXot9rIFBAvDP37nmOXBb7L5Drd1x
appid   app
user-agent  Android 11 {Z29vZ2xl} CPU_ABI arm64-v8a CPU_ABI2  HARDWARE taimen MODEL {UGl4ZWwgMiBYTA} network/WIFI shihuo/7.20.1 sc({holder},myapp) minVersion(15670) sh-dv-sign[v1|10418e17bc015815ef161fc2a5029c0d0d2751f79b8da0aa]
daga-ban-personal   0
accept-encoding gzip
'''
for good_id in l:
    print(good_id)

    headers = header_str_to_dict(header_str)
    res = requests.get(
        url=f'https://sh-gateway.shihuocdn.cn/v4/services/sh-goodsapi/app_swoole_shoe/preload/single?devices=Pixel%202%20XL&amp;dspm=2f92c97850d58c2d&amp;gender=2&amp;goods_id={good_id}&amp;sourceLocation=oneRowOne%3A%5BN%5D&amp;style_id=919350&amp;top_style_id=919350&amp;tpExtra=%7B%22sourceTp%22%3A%22home%3Asearch%3A%22%2C%22sourceTpName%22%3A%22%E5%8C%B9%E5%85%8B%22%2C%22wsf%22%3A%22normal_search_words%22%2C%22ast%22%3A%22%E5%8C%B9%E5%85%8B%22%2C%22is_inspire%22%3A0%2C%22dgReqId%22%3A%22SHSS_CG-O7CFRNPNL246_SPU_1%3A27%22%2C%22si%22%3A%228001%22%2C%22skc%22%3A%22919350%22%2C%22layer%22%3A%222%22%2C%22activityLabelType%22%3A%22GOODS_HOT%22%7D&amp;access_token=b7EM8Up9VSFJUhkyEJ&amp;minVersion=19612&amp;clientCode=%7Bholder%7D&amp;v=7.53.0&amp;channel=ali&amp;device=Pixel%202%20XL&amp;platform=android&amp;timestamp=1697020432473&amp;access_token=b7EM8Up9VSFJUhkyEJ&amp;token=fab91b9a4dd78dcf9f0f6f5a9800b9b5',
        verify=False, headers=headers)
    print(res.text)
    print('付款人数：', res.json()['data']['info']['goods_info']['monthSellPoint'])
    break

</code></pre>
<h2 id="83">8.3 新商品详情</h2>
<pre><code class="language-python">import requests

res = requests.get(
    'https://sh-gateway.shihuo.cn/v4/services/sh-goodsapi/public/detail',
    params={
        'goods_id': '1110460',
        'v': '7.73.0',
    },
    verify=False, headers=headers)
print(res.text)

</code></pre>
<h1 id="9">9、总结</h1>
<pre><code class="language-python"># 破解识货 搜索  详情

# 1 绕过app强制更新---》hook 弹窗
# 2 绕过frida反调试--》删除so文件
# 3 绕过app代理检测--》软件--》charles配置sockets方式
# 4 抓包分析破解搜索
# 5 抓包分析破解详情（目前看不到加密）
# 6 如果有加密的情况，如何尝试，各种hook脚本---》通用的，以后直接拿来用在其他app上分析即可
# 7 两个版本的完整代码

# 8 详情有两个接口
# 咱们实现
https://sh-gateway.shihuocdn.cn/v4/services/sh-goodsapi/app_swoole_shoe/preload/single
# 自行实现
https://sh-gateway.shihuo.cn/v4/services/sh-goodsapi/app_swoole_zone/commonDetail/v1?dspm=795a77e2036d0d3b&amp;id=489443&amp;lspm=d268634fc807ef68&amp;sex=1&amp;style_id=5153585&amp;minVersion=15670&amp;clientCode=%7Bholder%7D&amp;v=7.20.1&amp;channel=myapp&amp;device=Pixel%202%20XL&amp;platform=android&amp;timestamp=1697034456546&amp;access_token=b7EM8Up9VSFJUhkyEJ&amp;token=b5666bae3fad317726e0a0fa97a5fa5a




# 如果hook-base64---》知道走了它，再如何定位如何加密的
    -打印出 base64编码之前字符串:key=aasdf&amp;sign=asdfad&amp;data=asdfasdf
    -打印出base64之后的字符串：确认是不是走了
</code></pre>


</section>
</div> <!-- end of search-noresults -->
<div class="search-results">
<div class="has-results">

<h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
<ul class="search-results-list"></ul>

</div> <!-- end of has-results -->
<div class="no-results">

<h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>

</div> <!-- end of no-results -->
</div> <!-- end of search-results -->
</div> <!-- end of book-search-results -->

</div> <!-- end of page-inner -->
</div> <!-- end of page-wrapper -->

</div> <!-- end of body-inner -->

</div> <!-- end of book-body -->
<script src="./js/main.js"></script>
<script src="search/main.js"></script>
<script src="./js/gitbook.min.js"></script>
<script src="./js/theme.min.js"></script>
</body>
</html>